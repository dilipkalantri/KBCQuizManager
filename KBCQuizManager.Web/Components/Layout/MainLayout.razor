@inherits LayoutComponentBase
@inject IAuthService AuthService
@inject IUserService UserService
@inject NavigationManager NavigationManager

<MudThemeProvider IsDarkMode="true" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

@if (_isLoading)
{
    <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: #1a1a2e;">
        <div style="color: #7c3aed; font-size: 24px;">Loading...</div>
    </div>
}
else if (_currentUser == null)
{
    @Body
}
else
{
    <div style="display: flex; min-height: 100vh; background: #1a1a2e; font-family: 'Roboto', Arial, sans-serif;">
        <!-- Overlay -->
        <div class="drawer-overlay @(_drawerOpen ? "show" : "")" @onclick="CloseDrawer"></div>
        
        <!-- Sidebar -->
        <div class="sidebar @(_drawerOpen ? "sidebar-open" : "")">
            <div class="drawer-close">
                <span @onclick="CloseDrawer" style="color: #9ca3af; font-size: 28px; cursor: pointer; line-height: 1;">&times;</span>
            </div>
            
            <div style="padding: 0 20px 20px; border-bottom: 1px solid #2a3f5f;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 35px; height: 35px; background: linear-gradient(135deg, #7c3aed, #a855f7); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">IP</div>
                    <span style="color: white; font-size: 18px; font-weight: bold;">InternsPlay</span>
                </div>
            </div>
            
            <div style="margin: 15px; padding: 12px; background: #1a1a2e; border-radius: 8px; border: 1px solid #2a3f5f;">
                <div style="color: white; font-weight: 600; font-size: 14px;">@_currentUser.FullName</div>
                <div style="color: #7c3aed; font-size: 12px; margin-top: 2px;">@(_currentUser.Role == UserRole.SuperAdmin ? "Super Admin" : "Admin")</div>
                @if (!string.IsNullOrEmpty(_currentUser.AdminCode))
                {
                    <div style="margin-top: 8px; padding: 6px 10px; background: rgba(124, 58, 237, 0.15); border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 6px; display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="color: #9ca3af; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Your Code</div>
                            <div style="color: #a855f7; font-size: 16px; font-weight: 700; letter-spacing: 2px;">@_currentUser.AdminCode</div>
                        </div>
                        <button @onclick="CopyAdminCode" style="background: transparent; border: none; color: #9ca3af; cursor: pointer; font-size: 14px; padding: 4px;" title="Copy code">ğŸ“‹</button>
                    </div>
                }
            </div>
            
            <div style="padding: 0 10px;">
                <div style="color: #6b7280; font-size: 11px; padding: 12px 10px 6px; text-transform: uppercase; letter-spacing: 1px;">Menu</div>
                <a href="/" class="nav-link @(IsActive("/") ? "active" : "")" @onclick="CloseDrawer">ğŸ“Š Dashboard</a>
                
                @if (_currentUser.Role == UserRole.SuperAdmin)
                {
                    <div style="color: #6b7280; font-size: 11px; padding: 12px 10px 6px; text-transform: uppercase; letter-spacing: 1px;">Admin</div>
                    <a href="/superadmin/admins" class="nav-link @(IsActive("/superadmin") ? "active" : "")" @onclick="CloseDrawer">ğŸ‘¥ Manage Admins</a>
                }
                
                <div style="color: #6b7280; font-size: 11px; padding: 12px 10px 6px; text-transform: uppercase; letter-spacing: 1px;">Questions</div>
                <a href="/admin/categories" class="nav-link @(IsActive("/admin/categories") ? "active" : "")" @onclick="CloseDrawer">ğŸ“ Categories</a>
                <a href="/admin/questions" class="nav-link @(IsActive("/admin/questions") ? "active" : "")" @onclick="CloseDrawer">â“ All Questions</a>
                <a href="/admin/import" class="nav-link @(IsActive("/admin/import") ? "active" : "")" @onclick="CloseDrawer">ğŸ“¤ Import JSON</a>
                
                <div style="color: #6b7280; font-size: 11px; padding: 12px 10px 6px; text-transform: uppercase; letter-spacing: 1px;">Users</div>
                <a href="/admin/users" class="nav-link @(IsActive("/admin/users") ? "active" : "")" @onclick="CloseDrawer">ğŸ‘¤ Registered Users</a>
                
                <div style="color: #6b7280; font-size: 11px; padding: 12px 10px 6px; text-transform: uppercase; letter-spacing: 1px;">Game</div>
                <a href="/admin/play" class="nav-link @(IsActive("/admin/play") ? "active" : "")" @onclick="CloseDrawer">ğŸ® Play Game</a>
                <a href="/admin/multiplayer" class="nav-link @(IsActive("/admin/multiplayer") ? "active" : "")" @onclick="CloseDrawer">ğŸ‘¥ Multiplayer</a>
                <a href="/admin/game-history" class="nav-link @(IsActive("/admin/game-history") ? "active" : "")" @onclick="CloseDrawer">ğŸ“Š Game History</a>
                
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #2a3f5f;">
                    <a href="/home" class="nav-link" style="color: #10b981;" @onclick="CloseDrawer">ğŸŒ Public Home</a>
                    <a href="/account/logout" class="nav-link" style="color: #ef4444;">ğŸšª Logout</a>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="topbar">
                <button class="hamburger" @onclick="ToggleDrawer">â˜°</button>
                <div style="flex: 1;"></div>
                <span style="padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; @(_currentUser.Role == UserRole.SuperAdmin ? "background: #f59e0b; color: white;" : "background: #3b82f6; color: white;")" class="hide-mobile">
                    @(_currentUser.Role == UserRole.SuperAdmin ? "Super Admin" : "Admin")
                </span>
                <div style="width: 32px; height: 32px; background: #7c3aed; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px;">
                    @(_currentUser.FirstName?.Length > 0 ? _currentUser.FirstName[0] : 'U')
                </div>
                <span style="color: white; font-size: 14px;" class="hide-mobile">@_currentUser.FirstName</span>
            </div>
            
            <div style="padding: 15px 20px;">
                @Body
            </div>
        </div>
    </div>
}

@code {
    private bool _isLoading = true;
    private ApplicationUser? _currentUser;
    private bool _drawerOpen = false;

    [Inject] private IJSRuntime JSRuntime { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        if (uri.AbsolutePath != "/login" && !uri.AbsolutePath.StartsWith("/account"))
        {
            if (await AuthService.IsAuthenticatedAsync())
            {
                _currentUser = await AuthService.GetCurrentUserAsync();
            }
            else
            {
                NavigationManager.NavigateTo("/login");
                return;
            }
        }
        _isLoading = false;
    }

    private void ToggleDrawer() => _drawerOpen = !_drawerOpen;
    private void CloseDrawer() => _drawerOpen = false;

    private async Task CopyAdminCode()
    {
        if (_currentUser?.AdminCode != null)
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", _currentUser.AdminCode);
        }
    }

    private bool IsActive(string path)
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        if (path == "/") return uri.AbsolutePath == "/";
        return uri.AbsolutePath.StartsWith(path);
    }
}
