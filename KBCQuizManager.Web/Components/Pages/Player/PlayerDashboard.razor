@page "/player"
@inject IAuthService AuthService
@inject IGameService GameService
@inject IQuestionService QuestionService
@inject NavigationManager NavigationManager

<PageTitle>Player Dashboard - InternsHub</PageTitle>

@if (_currentUser != null)
{
    <div style="margin-bottom: 30px;">
        <h1 style="color: white; font-size: 28px; margin: 0 0 8px 0;">Welcome, @_currentUser.FirstName! ğŸ®</h1>
        <p style="color: #9ca3af; margin: 0;">Ready to play? Your game stats are below.</p>
    </div>

    <!-- Stats Cards -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
        <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <p style="color: #9ca3af; margin: 0 0 8px 0; font-size: 14px;">Games Played</p>
                    <h2 style="color: white; font-size: 32px; margin: 0;">@_stats.TotalGames</h2>
                </div>
                <div style="width: 45px; height: 45px; background: #7c3aed; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ®</div>
            </div>
        </div>
        
        <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <p style="color: #9ca3af; margin: 0 0 8px 0; font-size: 14px;">Games Won</p>
                    <h2 style="color: #10b981; font-size: 32px; margin: 0;">@_stats.GamesWon</h2>
                </div>
                <div style="width: 45px; height: 45px; background: #10b981; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ†</div>
            </div>
        </div>
        
        <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <p style="color: #9ca3af; margin: 0 0 8px 0; font-size: 14px;">Highest Prize</p>
                    <h2 style="color: #fbbf24; font-size: 24px; margin: 0;">@KBCPrizeStructure.FormatPrize(_stats.HighestPrize)</h2>
                </div>
                <div style="width: 45px; height: 45px; background: #f59e0b; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ’°</div>
            </div>
        </div>
        
        <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <p style="color: #9ca3af; margin: 0 0 8px 0; font-size: 14px;">Accuracy</p>
                    <h2 style="color: #3b82f6; font-size: 32px; margin: 0;">@_stats.AccuracyPercent.ToString("0")%</h2>
                </div>
                <div style="width: 45px; height: 45px; background: #3b82f6; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ¯</div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
        <a href="/player/play" style="text-decoration: none;">
            <div style="background: linear-gradient(135deg, #7c3aed, #6366f1); border-radius: 12px; padding: 30px; text-align: center; transition: all 0.2s;">
                <div style="font-size: 40px; margin-bottom: 12px;">ğŸ®</div>
                <h3 style="color: white; font-size: 18px; margin: 0 0 5px 0;">Play Game</h3>
                <p style="color: rgba(255,255,255,0.7); font-size: 13px; margin: 0;">Start a new KBC game</p>
            </div>
        </a>
        
        <a href="/player/history" style="text-decoration: none;">
            <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 30px; text-align: center; transition: all 0.2s;">
                <div style="font-size: 40px; margin-bottom: 12px;">ğŸ“Š</div>
                <h3 style="color: white; font-size: 18px; margin: 0 0 5px 0;">Game History</h3>
                <p style="color: #6b7280; font-size: 13px; margin: 0;">View past games</p>
            </div>
        </a>
        
        <a href="/player/leaderboard" style="text-decoration: none;">
            <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 30px; text-align: center; transition: all 0.2s;">
                <div style="font-size: 40px; margin-bottom: 12px;">ğŸ†</div>
                <h3 style="color: white; font-size: 18px; margin: 0 0 5px 0;">Leaderboard</h3>
                <p style="color: #6b7280; font-size: 13px; margin: 0;">See top players</p>
            </div>
        </a>
    </div>

    @if (!_canPlay)
    {
        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
            <p style="color: #f87171; margin: 0;">âš ï¸ Your admin doesn't have questions for all 15 levels yet. Missing levels: @string.Join(", ", _missingLevels)</p>
        </div>
    }
}

@code {
    private ApplicationUser? _currentUser;
    private GameStatistics _stats = new();
    private List<int> _missingLevels = new();
    private bool _canPlay = false;

    protected override async Task OnInitializedAsync()
    {
        _currentUser = await AuthService.GetCurrentUserAsync();
        if (_currentUser == null)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }
        
        if (_currentUser.Role != UserRole.Player)
        {
            NavigationManager.NavigateTo("/");
            return;
        }
        
        _stats = await GameService.GetPlayerGameStatisticsAsync(_currentUser.Id);
        
        if (_currentUser.LinkedAdminId.HasValue)
        {
            var levelCounts = await QuestionService.GetQuestionCountByLevelAsync(_currentUser.LinkedAdminId.Value);
            _missingLevels = Enumerable.Range(1, 15).Where(l => levelCounts.GetValueOrDefault(l, 0) == 0).ToList();
            _canPlay = !_missingLevels.Any();
        }
    }
}
