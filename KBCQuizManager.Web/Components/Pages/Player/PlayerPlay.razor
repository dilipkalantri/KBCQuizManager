@page "/player/play"
@inject IAuthService AuthService
@inject IGameService GameService
@inject IQuestionService QuestionService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Play Game - InternSpark</PageTitle>

<!-- Sound Elements -->
<audio id="soundCorrect" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundWrong" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2001/2001-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundTick" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundQuestion" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundWin" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundLifeline" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2570/2570-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundLevelUp" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" type="audio/mpeg"></audio>

@if (!_isPlaying)
{
    <!-- Start Screen -->
    <div style="max-width: 600px; margin: 0 auto; text-align: center; padding: 40px 20px;">
        <div style="font-size: 80px; margin-bottom: 20px;">üéÆ</div>
        <h1 style="color: white; font-size: 32px; margin: 0 0 10px 0;">Kaun Banega Crorepati</h1>
        <p style="color: #9ca3af; margin: 0 0 30px 0;">Answer 15 questions to win ‚Çπ7 Crore!</p>
        
        <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 25px; margin-bottom: 30px; text-align: left;">
            <h3 style="color: white; margin: 0 0 15px 0;">Player: @_currentUser?.FullName</h3>
            
            <h3 style="color: white; margin: 20px 0 15px 0;">Question Availability</h3>
            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                @for (int i = 1; i <= 15; i++)
                {
                    var level = i;
                    var count = _levelCounts.GetValueOrDefault(level, 0);
                    <span style="padding: 5px 10px; border-radius: 6px; font-size: 11px; background: @(count > 0 ? "#10b981" : "#ef4444"); color: white;">
                        L@level: @count
                    </span>
                }
            </div>
            @if (_missingLevels.Any())
            {
                <p style="color: #ef4444; font-size: 13px; margin: 15px 0 0 0;">‚ö†Ô∏è Missing questions for levels: @string.Join(", ", _missingLevels)</p>
            }
        </div>
        
        <button @onclick="StartGame" disabled="@(_missingLevels.Any())" 
                style="background: #7c3aed; color: white; border: none; padding: 15px 50px; border-radius: 10px; font-size: 18px; font-weight: 600; cursor: pointer; opacity: @(_missingLevels.Any() ? "0.5" : "1");">
            ‚ñ∂Ô∏è Start Game
        </button>
        
        <div style="margin-top: 20px;">
            <a href="/player/history" style="color: #7c3aed; text-decoration: none;">üìä View Game History</a>
        </div>
    </div>
}
else if (_gameSession != null)
{
    @if (_gameFinished)
    {
        <!-- Game Over Screen -->
        <div style="max-width: 600px; margin: 0 auto; text-align: center; padding: 40px 20px;">
            <div style="font-size: 100px; margin-bottom: 20px;">@(_gameSession.Status == GameStatus.Won ? "üèÜ" : "üòî")</div>
            <h1 style="color: white; font-size: 36px; margin: 0 0 10px 0;">
                @(_gameSession.Status == GameStatus.Won ? "Congratulations!" : "Game Over")
            </h1>
            <p style="color: #9ca3af; font-size: 18px; margin: 0 0 30px 0;">@_currentUser?.FullName</p>
            
            <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #fbbf24; border-radius: 16px; padding: 30px; margin-bottom: 30px;">
                <p style="color: #9ca3af; margin: 0 0 10px 0;">You Won</p>
                <h2 style="color: #fbbf24; font-size: 48px; margin: 0;">@KBCPrizeStructure.FormatPrize(_gameSession.FinalPrize)</h2>
                <p style="color: #6b7280; margin: 15px 0 0 0;">
                    Reached Level @_gameSession.CurrentLevel | @_gameSession.CorrectAnswers/@_gameSession.QuestionsAnswered Correct | Time: @_gameSession.GetDuration()
                </p>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button @onclick="ResetGame" style="background: #7c3aed; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; cursor: pointer;">
                    üîÑ Play Again
                </button>
                <a href="/player/history" style="background: transparent; border: 1px solid #2a3f5f; color: white; padding: 12px 30px; border-radius: 8px; text-decoration: none;">
                    üìä View History
                </a>
            </div>
        </div>
    }
    else if (_currentQuestion == null || _isLoading)
    {
        <div style="max-width: 600px; margin: 0 auto; text-align: center; padding: 100px 20px;">
            <div style="font-size: 60px; margin-bottom: 30px;">üéØ</div>
            <h2 style="color: white; margin: 0 0 15px 0;">Loading Question...</h2>
            <p style="color: #9ca3af; margin: 0 0 30px 0;">Level @_gameSession.CurrentLevel</p>
            <div style="width: 50px; height: 50px; border: 4px solid #2a3f5f; border-top: 4px solid #7c3aed; border-radius: 50%; margin: 0 auto; animation: pp-spin 1s linear infinite;"></div>
        </div>
        <style>@@keyframes pp-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
    }
    else
    {
        <!-- Game Play Screen -->
        <div style="max-width: 900px; margin: 0 auto;">
            <!-- Top Bar -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="background: #7c3aed; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600;">
                        Level @_gameSession.CurrentLevel / 15
                    </span>
                    <span style="color: #9ca3af;">@_currentUser?.FullName</span>
                </div>
                
                <!-- Timer -->
                <div style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid @(_timeRemaining <= 10 ? "#ef4444" : "#7c3aed"); display: flex; align-items: center; justify-content: center;">
                    <span style="color: @(_timeRemaining <= 10 ? "#ef4444" : "white"); font-size: 24px; font-weight: 700;">@_timeRemaining</span>
                </div>
                
                <div style="text-align: right;">
                    <p style="color: #9ca3af; margin: 0; font-size: 12px;">Prize</p>
                    <p style="color: #fbbf24; margin: 0; font-size: 24px; font-weight: 700;">@KBCPrizeStructure.FormatPrize(_currentQuestion.GetPrizeAmount())</p>
                </div>
            </div>
            
            <!-- Game Grid with Prize Ladder -->
            <div style="display: grid; grid-template-columns: 1fr 200px; gap: 20px;">
                <div>
                    <!-- Question -->
                    <div style="background: linear-gradient(180deg, #0f172a, #1e293b); border: 2px solid #7c3aed; border-radius: 16px; padding: 30px; margin-bottom: 20px;">
                        <h2 style="color: white; font-size: 20px; text-align: center; margin: 0; line-height: 1.6;">@_currentQuestion.QuestionText</h2>
                    </div>
                    
                    <!-- Options -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        @foreach (var opt in GetCurrentOptions())
                        {
                            var isHidden = _hiddenOptions.Contains(opt.Answer);
                            var isSelected = _selectedAnswer == opt.Answer;
                            var isCorrect = _showAnswer && opt.Answer == _currentQuestion.CorrectAnswer;
                            var isWrong = _showAnswer && isSelected && !isCorrect;
                            
                            <button @onclick="() => SelectAnswer(opt.Answer)" disabled="@(_showAnswer || isHidden)"
                                    style="padding: 18px 20px; border-radius: 12px; text-align: left; cursor: @(_showAnswer || isHidden ? "default" : "pointer"); opacity: @(isHidden ? "0.3" : "1");
                                           background: @(isCorrect ? "rgba(16, 185, 129, 0.3)" : isWrong ? "rgba(239, 68, 68, 0.3)" : isSelected ? "rgba(124, 58, 237, 0.3)" : "#1a1a2e");
                                           border: 2px solid @(isCorrect ? "#10b981" : isWrong ? "#ef4444" : isSelected ? "#7c3aed" : "#2a3f5f");
                                           color: white; font-size: 16px; transition: all 0.2s;">
                                <strong style="color: @(isCorrect ? "#10b981" : isWrong ? "#ef4444" : "#7c3aed"); margin-right: 10px;">@opt.Label.</strong>
                                @opt.Text
                                @if (isCorrect) { <span style="float: right; color: #10b981;">‚úì</span> }
                                @if (isWrong) { <span style="float: right; color: #ef4444;">‚úó</span> }
                            </button>
                        }
                    </div>
                    
                    <!-- Lifelines -->
                    <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                        <p style="color: #9ca3af; font-size: 12px; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px;">Lifelines</p>
                        <div style="display: flex; gap: 10px;">
                            <button @onclick="UseFiftyFifty" disabled="@(_localFiftyFiftyUsed || _showAnswer)"
                                    style="flex: 1; padding: 12px; border-radius: 8px; cursor: pointer; border: 1px solid @(_localFiftyFiftyUsed ? "#4b5563" : "#f59e0b"); background: @(_localFiftyFiftyUsed ? "#1a1a2e" : "rgba(245, 158, 11, 0.1)"); color: @(_localFiftyFiftyUsed ? "#4b5563" : "#f59e0b"); opacity: @(_localFiftyFiftyUsed ? "0.5" : "1");">
                                50:50
                            </button>
                            <button @onclick="UsePhoneAFriend" disabled="@(_localPhoneAFriendUsed || _showAnswer)"
                                    style="flex: 1; padding: 12px; border-radius: 8px; cursor: pointer; border: 1px solid @(_localPhoneAFriendUsed ? "#4b5563" : "#3b82f6"); background: @(_localPhoneAFriendUsed ? "#1a1a2e" : "rgba(59, 130, 246, 0.1)"); color: @(_localPhoneAFriendUsed ? "#4b5563" : "#3b82f6"); opacity: @(_localPhoneAFriendUsed ? "0.5" : "1");">
                                üìû Phone
                            </button>
                            <button @onclick="UseAudiencePoll" disabled="@(_localAudiencePollUsed || _showAnswer)"
                                    style="flex: 1; padding: 12px; border-radius: 8px; cursor: pointer; border: 1px solid @(_localAudiencePollUsed ? "#4b5563" : "#10b981"); background: @(_localAudiencePollUsed ? "#1a1a2e" : "rgba(16, 185, 129, 0.1)"); color: @(_localAudiencePollUsed ? "#4b5563" : "#10b981"); opacity: @(_localAudiencePollUsed ? "0.5" : "1");">
                                üë• Audience
                            </button>
                            <button @onclick="UseExpertAdvice" disabled="@(_localExpertAdviceUsed || _showAnswer)"
                                    style="flex: 1; padding: 12px; border-radius: 8px; cursor: pointer; border: 1px solid @(_localExpertAdviceUsed ? "#4b5563" : "#8b5cf6"); background: @(_localExpertAdviceUsed ? "#1a1a2e" : "rgba(139, 92, 246, 0.1)"); color: @(_localExpertAdviceUsed ? "#4b5563" : "#8b5cf6"); opacity: @(_localExpertAdviceUsed ? "0.5" : "1");">
                                üéì Expert
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lifeline Result -->
                    @if (!string.IsNullOrEmpty(_lifelineResult))
                    {
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                            <p style="color: #3b82f6; margin: 0;">@_lifelineResult</p>
                        </div>
                    }
                    
                    @if (_audiencePoll != null)
                    {
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                            <p style="color: #10b981; margin: 0 0 10px 0; font-weight: 600;">Audience Poll Results:</p>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                                @foreach (var (label, pct) in new[] { ("A", _audiencePoll.PercentageA), ("B", _audiencePoll.PercentageB), ("C", _audiencePoll.PercentageC), ("D", _audiencePoll.PercentageD) })
                                {
                                    <div style="text-align: center;">
                                        <div style="height: @(pct)px; max-height: 60px; background: #10b981; border-radius: 4px; margin-bottom: 5px;"></div>
                                        <span style="color: white;">@label: @pct%</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        @if (_selectedAnswer.HasValue && !_showAnswer)
                        {
                            <button @onclick="LockAnswer" style="background: #f59e0b; color: white; border: none; padding: 15px 40px; border-radius: 10px; font-size: 18px; font-weight: 600; cursor: pointer;">
                                üîí Lock Answer
                            </button>
                        }
                        @if (_showAnswer)
                        {
                            @if (_isCorrect)
                            {
                                <button @onclick="NextQuestion" style="background: #10b981; color: white; border: none; padding: 15px 40px; border-radius: 10px; font-size: 18px; font-weight: 600; cursor: pointer;">
                                    @(_gameSession.CurrentLevel >= 15 ? "üèÜ Claim Prize" : "Next Question ‚Üí")
                                </button>
                            }
                            else
                            {
                                <button @onclick="EndGame" style="background: #ef4444; color: white; border: none; padding: 15px 40px; border-radius: 10px; font-size: 18px; font-weight: 600; cursor: pointer;">
                                    End Game
                                </button>
                            }
                        }
                        @if (!_showAnswer)
                        {
                            <button @onclick="QuitGame" style="background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 15px 30px; border-radius: 10px; font-size: 16px; cursor: pointer;">
                                Quit & Take @KBCPrizeStructure.FormatPrize(_gameSession.CurrentPrize)
                            </button>
                        }
                    </div>
                </div>
                
                <!-- Prize Ladder -->
                <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 15px;">
                    <p style="color: #9ca3af; font-size: 11px; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px;">Prize Ladder</p>
                    @for (int i = 15; i >= 1; i--)
                    {
                        var level = i;
                        var isCurrent = level == _gameSession.CurrentLevel;
                        var isPassed = level < _gameSession.CurrentLevel;
                        var isMilestone = level == 5 || level == 10;
                        
                        <div style="display: flex; justify-content: space-between; padding: 6px 8px; margin-bottom: 2px; border-radius: 4px; background: @(isCurrent ? "#7c3aed" : isPassed ? "rgba(16, 185, 129, 0.2)" : "transparent"); border: @(isMilestone ? "1px solid #fbbf24" : "none");">
                            <span style="color: @(isCurrent ? "white" : isPassed ? "#10b981" : "#6b7280"); font-size: 12px;">@level</span>
                            <span style="color: @(isCurrent ? "white" : isPassed ? "#10b981" : isMilestone ? "#fbbf24" : "#9ca3af"); font-size: 12px; font-weight: @(isMilestone ? "600" : "400");">
                                @KBCPrizeStructure.FormatPrize(KBCPrizeStructure.LevelPrizes[level])
                            </span>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
}
else if (_isPlaying)
{
    <div style="max-width: 600px; margin: 0 auto; text-align: center; padding: 100px 20px;">
        <div style="font-size: 60px; margin-bottom: 30px;">üéÆ</div>
        <h2 style="color: white; margin: 0 0 15px 0;">Starting Game...</h2>
        <div style="width: 50px; height: 50px; border: 4px solid #2a3f5f; border-top: 4px solid #7c3aed; border-radius: 50%; margin: 0 auto; animation: pp-spin 1s linear infinite;"></div>
    </div>
    <style>@@keyframes pp-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
}

@code {
    private ApplicationUser? _currentUser;
    private Guid _adminId;
    private Dictionary<int, int> _levelCounts = new();
    private List<int> _missingLevels = new();
    private bool _isPlaying = false;
    private bool _gameFinished = false;
    private bool _isDisposed = false;
    private bool _isLoading = false;
    
    private GameSession? _gameSession;
    private Question? _currentQuestion;
    private List<Guid> _usedQuestionIds = new();
    
    private CorrectOption? _selectedAnswer;
    private bool _showAnswer = false;
    private bool _isCorrect = false;
    
    private int _timeRemaining = 30;
    private System.Threading.Timer? _timer;
    private int _timeTaken = 0;
    
    private List<CorrectOption> _hiddenOptions = new();
    private string _lifelineResult = "";
    private AudiencePollResult? _audiencePoll;
    private LifelineUsage _currentLifelineUsage = new();
    
    private bool _localFiftyFiftyUsed = false;
    private bool _localPhoneAFriendUsed = false;
    private bool _localAudiencePollUsed = false;
    private bool _localExpertAdviceUsed = false;

    protected override async Task OnInitializedAsync()
    {
        _currentUser = await AuthService.GetCurrentUserAsync();
        if (_currentUser == null || _currentUser.Role != UserRole.Player || !_currentUser.LinkedAdminId.HasValue)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }
        
        _adminId = _currentUser.LinkedAdminId.Value;
        _levelCounts = await QuestionService.GetQuestionCountByLevelAsync(_adminId);
        _missingLevels = Enumerable.Range(1, 15).Where(l => _levelCounts.GetValueOrDefault(l, 0) == 0).ToList();
    }

    private async Task StartGame()
    {
        if (_missingLevels.Any()) return;
        
        _gameSession = await GameService.StartNewGameAsync(_currentUser!.FullName, _adminId, _currentUser.Id);
        _usedQuestionIds.Clear();
        _isPlaying = true;
        _gameFinished = false;
        _localFiftyFiftyUsed = false;
        _localPhoneAFriendUsed = false;
        _localAudiencePollUsed = false;
        _localExpertAdviceUsed = false;
        
        await LoadQuestion();
    }

    private async Task LoadQuestion()
    {
        if (_gameSession == null) return;
        _timer?.Dispose(); _timer = null;
        _isLoading = true; _currentQuestion = null;
        StateHasChanged();
        
        try
        {
            await Task.Delay(100);
            _currentQuestion = await GameService.GetQuestionForLevelAsync(_gameSession.CurrentLevel, _adminId, _usedQuestionIds);
            
            if (_currentQuestion == null)
            {
                Snackbar.Add($"No question available for level {_gameSession.CurrentLevel}", Severity.Error);
                _isLoading = false;
                return;
            }
            
            _usedQuestionIds.Add(_currentQuestion.Id);
            _selectedAnswer = null; _showAnswer = false; _isCorrect = false;
            _hiddenOptions.Clear(); _lifelineResult = ""; _audiencePoll = null;
            _currentLifelineUsage = new();
            _isLoading = false;
            
            await PlaySound("soundQuestion");
            _timeRemaining = _currentQuestion.GetTimeLimitForLevel();
            _timeTaken = 0;
            StartTimer();
        }
        catch (Exception ex)
        {
            _isLoading = false;
            Snackbar.Add($"Error loading question: {ex.Message}", Severity.Error);
        }
    }

    private void StartTimer()
    {
        _timer?.Dispose();
        _timer = new System.Threading.Timer(async _ =>
        {
            try
            {
                if (_timer == null || _isDisposed) return;
                _timeRemaining--; _timeTaken++;
                if (_timeRemaining <= 0)
                {
                    _timer?.Dispose(); _timer = null;
                    if (!_isDisposed) await InvokeAsync(async () => { await TimeOut(); StateHasChanged(); });
                }
                else if (!_isDisposed) await InvokeAsync(StateHasChanged);
            }
            catch { }
        }, null, 1000, 1000);
    }

    private async Task TimeOut()
    {
        _timer?.Dispose(); _timer = null;
        _showAnswer = true; _isCorrect = false;
        try
        {
            _gameSession = await GameService.RecordAnswerAsync(_gameSession!.Id, _currentQuestion!.Id, null, _timeTaken, true, _currentLifelineUsage);
            _gameFinished = true;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error recording timeout: {ex.Message}", Severity.Error);
            _gameFinished = true;
        }
    }

    private void SelectAnswer(CorrectOption answer)
    {
        if (!_showAnswer && !_hiddenOptions.Contains(answer)) _selectedAnswer = answer;
    }

    private async Task LockAnswer()
    {
        if (!_selectedAnswer.HasValue || _currentQuestion == null || _gameSession == null) return;
        _timer?.Dispose(); _timer = null;
        _showAnswer = true;
        _isCorrect = _selectedAnswer == _currentQuestion.CorrectAnswer;
        await PlaySound(_isCorrect ? "soundCorrect" : "soundWrong");
        
        try
        {
            _gameSession = await GameService.RecordAnswerAsync(_gameSession.Id, _currentQuestion.Id, _selectedAnswer, _timeTaken, false, _currentLifelineUsage);
            if (!_isCorrect || _gameSession.Status != GameStatus.InProgress)
            {
                _gameFinished = true;
                if (_gameSession.Status == GameStatus.Won) await PlaySound("soundWin");
            }
            else await PlaySound("soundLevelUp");
        }
        catch (Exception ex) { Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
    }

    private async Task NextQuestion()
    {
        _timer?.Dispose(); _timer = null;
        if (_gameSession?.Status == GameStatus.Won) _gameFinished = true;
        else
        {
            try { await LoadQuestion(); }
            catch (Exception ex) { Snackbar.Add($"Error: {ex.Message}", Severity.Error); _gameFinished = true; }
        }
    }

    private async Task QuitGame()
    {
        _timer?.Dispose(); _timer = null;
        _gameSession = await GameService.QuitGameAsync(_gameSession!.Id);
        _gameFinished = true;
    }

    private void EndGame() => _gameFinished = true;

    private void ResetGame()
    {
        _timer?.Dispose(); _timer = null;
        _isPlaying = false; _isLoading = false; _gameFinished = false;
        _gameSession = null; _currentQuestion = null;
        _usedQuestionIds.Clear();
        _localFiftyFiftyUsed = false; _localPhoneAFriendUsed = false;
        _localAudiencePollUsed = false; _localExpertAdviceUsed = false;
    }

    // Lifelines
    private async Task UseFiftyFifty()
    {
        if (_gameSession == null || _currentQuestion == null || _localFiftyFiftyUsed || _showAnswer) return;
        try
        {
            _localFiftyFiftyUsed = true;
            var (removed, _) = await GameService.GetFiftyFiftyOptionsAsync(_currentQuestion);
            _hiddenOptions = removed; _currentLifelineUsage.FiftyFifty = true;
            StateHasChanged();
        }
        catch (Exception ex) { _localFiftyFiftyUsed = false; Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
    }

    private async Task UsePhoneAFriend()
    {
        if (_gameSession == null || _currentQuestion == null || _localPhoneAFriendUsed || _showAnswer) return;
        try
        {
            _localPhoneAFriendUsed = true;
            _lifelineResult = await GameService.GetPhoneAFriendHintAsync(_currentQuestion);
            _currentLifelineUsage.PhoneAFriend = true;
            StateHasChanged();
        }
        catch (Exception ex) { _localPhoneAFriendUsed = false; Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
    }

    private async Task UseAudiencePoll()
    {
        if (_gameSession == null || _currentQuestion == null || _localAudiencePollUsed || _showAnswer) return;
        try
        {
            _localAudiencePollUsed = true;
            _audiencePoll = await GameService.GetAudiencePollAsync(_currentQuestion);
            _currentLifelineUsage.AudiencePoll = true;
            StateHasChanged();
        }
        catch (Exception ex) { _localAudiencePollUsed = false; Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
    }

    private async Task UseExpertAdvice()
    {
        if (_gameSession == null || _currentQuestion == null || _localExpertAdviceUsed || _showAnswer) return;
        try
        {
            _localExpertAdviceUsed = true;
            var (answer, confidence) = await GameService.GetExpertAdviceAsync(_currentQuestion);
            _lifelineResult = $"üéì Expert says: \"I'm {confidence}% confident the answer is Option {answer}\"";
            _currentLifelineUsage.ExpertAdvice = true;
            StateHasChanged();
        }
        catch (Exception ex) { _localExpertAdviceUsed = false; Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
    }

    private List<(string Label, string Text, CorrectOption Answer)> GetCurrentOptions() => _currentQuestion == null
        ? new()
        : new() { ("A", _currentQuestion.OptionA, CorrectOption.A), ("B", _currentQuestion.OptionB, CorrectOption.B), ("C", _currentQuestion.OptionC, CorrectOption.C), ("D", _currentQuestion.OptionD, CorrectOption.D) };

    private async Task PlaySound(string soundId)
    {
        try { await JSRuntime.InvokeVoidAsync("eval", $"document.getElementById('{soundId}')?.play()"); } catch { }
    }

    public void Dispose() { _isDisposed = true; _timer?.Dispose(); _timer = null; }
}
