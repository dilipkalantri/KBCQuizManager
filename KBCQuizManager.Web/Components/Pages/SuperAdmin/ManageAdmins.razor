@page "/superadmin/admins"
@inject IAuthService AuthService
@inject IUserService UserService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime

<PageTitle>Manage Admins - InternSpark</PageTitle>

<!-- Header -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 10px;">
    <div>
        <h1 style="color: white; font-size: 28px; margin: 0 0 8px 0;">Manage Admins</h1>
        <p style="color: #9ca3af; margin: 0;">Create and manage quiz administrators</p>
    </div>
    <button @onclick="OpenAddDialog" style="background: #7c3aed; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
        ‚ûï Add Admin
    </button>
</div>

@if (_isLoading)
{
    <div style="text-align: center; padding: 60px; color: #9ca3af;">Loading...</div>
}
else if (_admins.Any())
{
    <div style="display: flex; flex-direction: column; gap: 15px;">
        @foreach (var admin in _admins)
        {
            <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="width: 50px; height: 50px; background: @(admin.IsActive ? "#7c3aed" : "#4b5563"); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 20px;">
                            @(admin.FirstName?.Length > 0 ? admin.FirstName[0] : 'A')
                        </div>
                        <div>
                            <h3 style="color: white; font-size: 18px; margin: 0 0 5px 0;">@admin.FullName</h3>
                            <p style="color: #9ca3af; font-size: 14px; margin: 0;">@admin.Email</p>
                        </div>
                    </div>
                    
                    <!-- Admin Code -->
                    <div style="background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; padding: 10px 15px; display: flex; align-items: center; gap: 10px;">
                        <div>
                            <div style="color: #6b7280; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Admin Code</div>
                            <div style="color: #a855f7; font-size: 18px; font-weight: 700; letter-spacing: 3px; font-family: monospace;">@(admin.AdminCode ?? "N/A")</div>
                        </div>
                        <button @onclick="() => CopyCode(admin.AdminCode)" style="background: transparent; border: 1px solid #2a3f5f; color: #9ca3af; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Copy code">üìã</button>
                        <button @onclick="() => RegenerateCode(admin)" style="background: transparent; border: 1px solid #2a3f5f; color: #f59e0b; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Generate new code">üîÑ</button>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div style="text-align: right;">
                            <span style="display: inline-block; padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; background: @(admin.IsActive ? "rgba(16, 185, 129, 0.2)" : "rgba(239, 68, 68, 0.2)"); color: @(admin.IsActive ? "#10b981" : "#ef4444");">
                                @(admin.IsActive ? "Active" : "Inactive")
                            </span>
                            <p style="color: #6b7280; font-size: 12px; margin: 8px 0 0 0;">Joined @admin.CreatedAt.ToString("MMM dd, yyyy")</p>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button @onclick="() => ToggleAdminStatus(admin)" style="background: transparent; border: 1px solid #2a3f5f; color: @(admin.IsActive ? "#f59e0b" : "#10b981"); padding: 8px; border-radius: 6px; cursor: pointer;">
                                @(admin.IsActive ? "‚è∏Ô∏è" : "‚ñ∂Ô∏è")
                            </button>
                            <button @onclick="() => DeleteAdmin(admin)" style="background: transparent; border: 1px solid #2a3f5f; color: #ef4444; padding: 8px; border-radius: 6px; cursor: pointer;">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 60px; text-align: center;">
        <div style="font-size: 64px; margin-bottom: 15px;">üë•</div>
        <h3 style="color: #9ca3af; font-size: 20px; margin: 0 0 10px 0;">No admins yet</h3>
        <p style="color: #6b7280; margin: 0 0 20px 0;">Create your first admin to get started</p>
        <button @onclick="OpenAddDialog" style="background: #7c3aed; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
            Add First Admin
        </button>
    </div>
}

<!-- Add Admin Dialog -->
@if (_showDialog)
{
    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 25px; width: 450px; max-width: 90%;">
            <h2 style="color: white; font-size: 20px; margin: 0 0 20px 0;">Add New Admin</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 8px;">First Name *</label>
                    <input @bind="_newAdmin.FirstName" style="width: 100%; padding: 10px; background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; color: white; font-size: 14px;" />
                </div>
                <div>
                    <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 8px;">Last Name *</label>
                    <input @bind="_newAdmin.LastName" style="width: 100%; padding: 10px; background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; color: white; font-size: 14px;" />
                </div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 8px;">Email *</label>
                <input @bind="_newAdmin.Email" type="email" style="width: 100%; padding: 10px; background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; color: white; font-size: 14px;" />
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 8px;">Password *</label>
                <input @bind="_password" type="password" style="width: 100%; padding: 10px; background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; color: white; font-size: 14px;" />
            </div>
            
            <div style="background: rgba(124, 58, 237, 0.1); border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                <p style="color: #a855f7; margin: 0; font-size: 13px;">üí° A unique Admin Code will be auto-generated. The admin can share this code with users to give them access to play games.</p>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button @onclick="CloseDialog" style="background: transparent; border: 1px solid #2a3f5f; color: #9ca3af; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Cancel</button>
                <button @onclick="CreateAdmin" style="background: #7c3aed; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Create Admin</button>
            </div>
        </div>
    </div>
}

@code {
    private ApplicationUser? _currentUser;
    private List<ApplicationUser> _admins = new();
    private bool _isLoading = true;
    private bool _showDialog = false;
    private ApplicationUser _newAdmin = new();
    private string _password = "";

    protected override async Task OnInitializedAsync()
    {
        _currentUser = await AuthService.GetCurrentUserAsync();
        await LoadAdmins();
    }

    private async Task LoadAdmins()
    {
        _isLoading = true;
        _admins = await UserService.GetAllAdminsAsync();
        _isLoading = false;
    }

    private void OpenAddDialog()
    {
        _newAdmin = new ApplicationUser();
        _password = "";
        _showDialog = true;
    }

    private void CloseDialog()
    {
        _showDialog = false;
        _newAdmin = new();
        _password = "";
    }

    private async Task CreateAdmin()
    {
        if (string.IsNullOrWhiteSpace(_newAdmin.FirstName) || string.IsNullOrWhiteSpace(_newAdmin.Email) || string.IsNullOrWhiteSpace(_password))
        {
            Snackbar.Add("Please fill all required fields", Severity.Warning);
            return;
        }

        var (success, message, createdUser) = await UserService.CreateAdminWithReturnAsync(_newAdmin, _password, _currentUser!.Id);
        if (success && createdUser != null)
        {
            // Snackbar.Add(message, Severity.Success);
            // Add the created admin directly to the list
            _admins.Add(createdUser);
            StateHasChanged();
            CloseDialog();
        }
        else
        {
            Snackbar.Add(message, Severity.Error);
        }
    }

    private async Task CopyCode(string? code)
    {
        if (!string.IsNullOrEmpty(code))
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", code);
            // Snackbar.Add("Admin code copied!", Severity.Info);
        }
    }

    private async Task RegenerateCode(ApplicationUser admin)
    {
        var confirm = await DialogService.ShowMessageBox("Regenerate Code", $"Generate a new code for '{admin.FullName}'? The old code will stop working.", yesText: "Regenerate", cancelText: "Cancel");
        if (confirm == true)
        {
            var (success, message) = await UserService.RegenerateAdminCodeAsync(admin.Id);
            if (!success) Snackbar.Add(message, Severity.Error);
            if (success) await LoadAdmins();
        }
    }

    private async Task ToggleAdminStatus(ApplicationUser admin)
    {
        var (success, message) = await UserService.ToggleUserStatusAsync(admin.Id);
        if (!success) Snackbar.Add(message, Severity.Error);
        if (success) await LoadAdmins();
    }

    private async Task DeleteAdmin(ApplicationUser admin)
    {
        var confirm = await DialogService.ShowMessageBox("Delete Admin", $"Delete '{admin.FullName}'? This cannot be undone.", yesText: "Delete", cancelText: "Cancel");
        if (confirm == true)
        {
            var (success, message) = await UserService.DeleteUserAsync(admin.Id);
            if (!success) Snackbar.Add(message, Severity.Error);
            if (success) await LoadAdmins();
        }
    }
}
