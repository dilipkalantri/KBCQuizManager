@page "/"
@inject IAuthService AuthService
@inject IQuestionService QuestionService
@inject ICategoryService CategoryService
@inject IGameService GameService

<PageTitle>Dashboard - InternsPlay</PageTitle>

@if (_currentUser != null)
{
    <!-- Welcome -->
    <div style="margin-bottom: 30px;">
        <h1 style="color: white; font-size: 28px; margin: 0 0 8px 0;">Welcome back, @_currentUser.FirstName! üëã</h1>
        <p style="color: #9ca3af; margin: 0;">Here's your InternsPlay management overview.</p>
    </div>
    
    <!-- Stats Cards -->
    <div class="grid-4col" style="margin-bottom: 30px;">
        <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <p style="color: #9ca3af; margin: 0 0 8px 0; font-size: 14px;">Total Questions</p>
                    <h2 style="color: white; font-size: 32px; margin: 0;">@_stats.TotalQuestions</h2>
                </div>
                <div style="width: 45px; height: 45px; background: #7c3aed; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px;">‚ùì</div>
            </div>
        </div>
        
        <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <p style="color: #9ca3af; margin: 0 0 8px 0; font-size: 14px;">Games Played</p>
                    <h2 style="color: white; font-size: 32px; margin: 0;">@_gameStats.TotalGames</h2>
                </div>
                <div style="width: 45px; height: 45px; background: #3b82f6; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px;">üéÆ</div>
            </div>
        </div>
        
        <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <p style="color: #9ca3af; margin: 0 0 8px 0; font-size: 14px;">Games Won</p>
                    <h2 style="color: #10b981; font-size: 32px; margin: 0;">@_gameStats.GamesWon</h2>
                </div>
                <div style="width: 45px; height: 45px; background: #10b981; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px;">üèÜ</div>
            </div>
        </div>
        
        <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <p style="color: #9ca3af; margin: 0 0 8px 0; font-size: 14px;">Highest Prize</p>
                    <h2 style="color: #fbbf24; font-size: 24px; margin: 0;">@KBCPrizeStructure.FormatPrize(_gameStats.HighestPrize)</h2>
                </div>
                <div style="width: 45px; height: 45px; background: #f59e0b; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px;">üí∞</div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div style="margin-bottom: 30px;">
        <h2 style="color: white; font-size: 20px; margin: 0 0 15px 0;">Quick Actions</h2>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
            <a href="/admin/play" style="text-decoration: none;">
                <div style="background: linear-gradient(135deg, #7c3aed, #6366f1); border-radius: 10px; padding: 20px; transition: all 0.2s;">
                    <div style="font-size: 28px; margin-bottom: 10px;">üéÆ</div>
                    <h3 style="color: white; font-size: 16px; margin: 0 0 5px 0;">Play Game</h3>
                    <p style="color: rgba(255,255,255,0.7); font-size: 13px; margin: 0;">Start a new game</p>
                </div>
            </a>
            
            <a href="/admin/questions" style="text-decoration: none;">
                <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 10px; padding: 20px; transition: all 0.2s;">
                    <div style="font-size: 28px; margin-bottom: 10px;">‚ûï</div>
                    <h3 style="color: white; font-size: 16px; margin: 0 0 5px 0;">Add Questions</h3>
                    <p style="color: #6b7280; font-size: 13px; margin: 0;">Create by level (1-15)</p>
                </div>
            </a>
            
            <a href="/admin/import" style="text-decoration: none;">
                <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 10px; padding: 20px; transition: all 0.2s;">
                    <div style="font-size: 28px; margin-bottom: 10px;">üì§</div>
                    <h3 style="color: white; font-size: 16px; margin: 0 0 5px 0;">Import JSON</h3>
                    <p style="color: #6b7280; font-size: 13px; margin: 0;">Bulk import by level</p>
                </div>
            </a>
            
            <a href="/admin/game-history" style="text-decoration: none;">
                <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 10px; padding: 20px; transition: all 0.2s;">
                    <div style="font-size: 28px; margin-bottom: 10px;">üìä</div>
                    <h3 style="color: white; font-size: 16px; margin: 0 0 5px 0;">Game History</h3>
                    <p style="color: #6b7280; font-size: 13px; margin: 0;">View past games</p>
                </div>
            </a>
        </div>
    </div>
    
    <!-- Two Column Layout -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <!-- Questions by Level -->
        <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 25px;">
            <h2 style="color: white; font-size: 18px; margin: 0 0 20px 0;">Questions by Level</h2>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                @for (int i = 1; i <= 15; i++)
                {
                    var level = i;
                    var count = _levelCounts.GetValueOrDefault(level, 0);
                    <div style="background: #1a1a2e; border: 1px solid @(count > 0 ? "#10b981" : "#ef4444"); border-radius: 8px; padding: 10px; text-align: center;">
                        <p style="color: @GetLevelColor(level); font-size: 11px; margin: 0;">L@level</p>
                        <p style="color: @(count > 0 ? "white" : "#ef4444"); font-size: 18px; font-weight: 700; margin: 5px 0 0 0;">@count</p>
                    </div>
                }
            </div>
            @if (_missingLevels.Any())
            {
                <p style="color: #ef4444; font-size: 13px; margin: 15px 0 0 0;">‚ö†Ô∏è Add questions for levels: @string.Join(", ", _missingLevels)</p>
            }
            else
            {
                <p style="color: #10b981; font-size: 13px; margin: 15px 0 0 0;">‚úÖ All levels have questions - Ready to play!</p>
            }
        </div>
        
        <!-- Categories -->
        <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: white; font-size: 18px; margin: 0;">Your Categories</h2>
                <a href="/admin/categories" style="color: #7c3aed; font-size: 14px; text-decoration: none;">View All</a>
            </div>
            
            @if (_categories.Any())
            {
                @foreach (var cat in _categories.Take(5))
                {
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #1a1a2e; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 35px; height: 35px; background: @(cat.Color ?? "#7c3aed"); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;">üìÅ</div>
                            <span style="color: white;">@cat.Name</span>
                        </div>
                        <span style="background: #2a3f5f; color: #7c3aed; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">@cat.QuestionCount</span>
                    </div>
                }
            }
            else
            {
                <div style="text-align: center; padding: 30px;">
                    <p style="color: #6b7280; margin: 0 0 15px 0;">No categories yet</p>
                    <a href="/admin/categories" style="color: #7c3aed; text-decoration: none;">Create your first category ‚Üí</a>
                </div>
            }
        </div>
    </div>
}

@code {
    private ApplicationUser? _currentUser;
    private QuestionStatistics _stats = new();
    private GameStatistics _gameStats = new();
    private List<Category> _categories = new();
    private Dictionary<int, int> _levelCounts = new();
    private List<int> _missingLevels = new();

    protected override async Task OnInitializedAsync()
    {
        _currentUser = await AuthService.GetCurrentUserAsync();
        if (_currentUser != null)
        {
            _stats = await QuestionService.GetStatisticsAsync(_currentUser.Id);
            _categories = await CategoryService.GetCategoriesAsync(_currentUser.Id);
            _gameStats = await GameService.GetGameStatisticsAsync(_currentUser.Id);
            _levelCounts = await QuestionService.GetQuestionCountByLevelAsync(_currentUser.Id);
            _missingLevels = Enumerable.Range(1, 15).Where(l => _levelCounts.GetValueOrDefault(l, 0) == 0).ToList();
        }
    }

    private string GetLevelColor(int level) => level switch
    {
        <= 5 => "#10b981",
        <= 10 => "#f59e0b",
        <= 13 => "#ef4444",
        _ => "#8b5cf6"
    };
}
