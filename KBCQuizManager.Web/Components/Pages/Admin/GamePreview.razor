@page "/admin/game-preview"
@inject IAuthService AuthService
@inject IQuestionService QuestionService

<PageTitle>Game Preview - KBC Quiz Manager</PageTitle>

<!-- Header -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
    <div>
        <h1 style="color: white; font-size: 28px; margin: 0 0 8px 0;">Game Preview</h1>
        <p style="color: #9ca3af; margin: 0;">Test your KBC quiz experience</p>
    </div>
    @if (!_isPlaying)
    {
        <button @onclick="StartGame" disabled="@(_questions.Count == 0)" style="background: #7c3aed; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; opacity: @(_questions.Count == 0 ? "0.5" : "1");">
            ‚ñ∂Ô∏è Start Game
        </button>
    }
</div>

@if (!_isPlaying)
{
    <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 60px; text-align: center;">
        @if (_questions.Count == 0)
        {
            <div style="font-size: 64px; margin-bottom: 15px;">‚ö†Ô∏è</div>
            <h3 style="color: #9ca3af; font-size: 20px; margin: 0 0 10px 0;">No Questions Available</h3>
            <p style="color: #6b7280; margin: 0 0 20px 0;">Add some questions to your question bank first</p>
            <a href="/admin/questions" style="color: #7c3aed; text-decoration: none;">Go to Questions ‚Üí</a>
        }
        else
        {
            <div style="font-size: 64px; margin-bottom: 15px;">üéÆ</div>
            <h3 style="color: white; font-size: 20px; margin: 0 0 10px 0;">Ready to Play!</h3>
            <p style="color: #6b7280; margin: 0;">You have @_questions.Count questions available</p>
        }
    </div>
}
else
{
    <div style="background: linear-gradient(180deg, #0f172a, #1e293b); border: 2px solid #7c3aed; border-radius: 16px; padding: 40px;">
        @if (_gameFinished)
        {
            <div style="text-align: center;">
                <div style="font-size: 80px; margin-bottom: 20px;">üèÜ</div>
                <h2 style="color: white; font-size: 32px; margin: 0 0 15px 0;">@(_currentQuestionIndex == _gameQuestions.Count ? "Congratulations!" : "Game Over")</h2>
                <p style="font-size: 48px; font-weight: 700; color: #fbbf24; margin: 0 0 10px 0;">‚Çπ@_currentPrize.ToString("N0")</p>
                <p style="color: #9ca3af; margin: 0 0 30px 0;">You answered @_currentQuestionIndex out of @_gameQuestions.Count questions correctly</p>
                <button @onclick="ResetGame" style="background: #7c3aed; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; cursor: pointer;">Play Again</button>
            </div>
        }
        else if (_currentQuestion != null)
        {
            <!-- Progress -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <span style="background: #2a3f5f; color: #7c3aed; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;">Question @(_currentQuestionIndex + 1) of @_gameQuestions.Count</span>
                <span style="font-size: 24px; font-weight: 700; color: #fbbf24;">‚Çπ@_currentQuestion.PrizeAmount.ToString("N0")</span>
            </div>
            
            <!-- Question -->
            <h2 style="color: white; font-size: 22px; text-align: center; margin: 0 0 40px 0; line-height: 1.5;">@_currentQuestion.QuestionText</h2>
            
            <!-- Options -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px;">
                @foreach (var opt in GetCurrentOptions())
                {
                    var isSelected = _selectedAnswer == opt.Answer;
                    var isCorrect = _showAnswer && opt.Answer == _currentQuestion.CorrectAnswer;
                    var isWrong = _showAnswer && isSelected && !isCorrect;
                    
                    <button @onclick="() => SelectAnswer(opt.Answer)" disabled="@_showAnswer"
                            style="padding: 18px 20px; border-radius: 10px; text-align: left; cursor: @(_showAnswer ? "default" : "pointer");
                                   background: @(isCorrect ? "rgba(16, 185, 129, 0.2)" : isWrong ? "rgba(239, 68, 68, 0.2)" : isSelected ? "rgba(124, 58, 237, 0.2)" : "#1a1a2e");
                                   border: 2px solid @(isCorrect ? "#10b981" : isWrong ? "#ef4444" : isSelected ? "#7c3aed" : "#2a3f5f");
                                   color: @(isCorrect ? "#10b981" : isWrong ? "#ef4444" : "white"); font-size: 16px;">
                        <strong style="margin-right: 10px;">@opt.Label.</strong> @opt.Text
                        @if (isCorrect) { <span style="float: right;">‚úì</span> }
                        @if (isWrong) { <span style="float: right;">‚úó</span> }
                    </button>
                }
            </div>
            
            <!-- Actions -->
            <div style="text-align: center;">
                @if (_selectedAnswer.HasValue && !_showAnswer)
                {
                    <button @onclick="LockAnswer" style="background: #f59e0b; color: white; border: none; padding: 15px 40px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                        üîí Lock Answer
                    </button>
                }
                @if (_showAnswer)
                {
                    @if (_isCorrect)
                    {
                        <button @onclick="NextQuestion" style="background: #10b981; color: white; border: none; padding: 15px 40px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                            @(_currentQuestionIndex + 1 < _gameQuestions.Count ? "Next Question ‚Üí" : "Finish Game üèÜ")
                        </button>
                    }
                    else
                    {
                        <button @onclick="EndGame" style="background: #ef4444; color: white; border: none; padding: 15px 40px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                            End Game
                        </button>
                    }
                }
            </div>
        }
    </div>
}

@code {
    private ApplicationUser? _currentUser;
    private List<Question> _questions = new();
    private List<Question> _gameQuestions = new();
    private bool _isPlaying = false;
    private bool _gameFinished = false;
    private int _currentQuestionIndex = 0;
    private Question? _currentQuestion;
    private CorrectOption? _selectedAnswer;
    private bool _showAnswer = false;
    private bool _isCorrect = false;
    private long _currentPrize = 0;

    protected override async Task OnInitializedAsync()
    {
        _currentUser = await AuthService.GetCurrentUserAsync();
        if (_currentUser != null)
            _questions = await QuestionService.GetRandomQuestionsForGameAsync(_currentUser.Id, 15);
    }

    private void StartGame()
    {
        _gameQuestions = _questions.OrderBy(q => (int)q.Difficulty).ThenBy(_ => Guid.NewGuid()).Take(15).ToList();
        _currentQuestionIndex = 0;
        _currentPrize = 0;
        _isPlaying = true;
        _gameFinished = false;
        LoadCurrentQuestion();
    }

    private void LoadCurrentQuestion()
    {
        if (_currentQuestionIndex < _gameQuestions.Count)
        {
            _currentQuestion = _gameQuestions[_currentQuestionIndex];
            _selectedAnswer = null;
            _showAnswer = false;
            _isCorrect = false;
        }
    }

    private void SelectAnswer(CorrectOption answer) { if (!_showAnswer) _selectedAnswer = answer; }

    private void LockAnswer()
    {
        if (_selectedAnswer.HasValue && _currentQuestion != null)
        {
            _showAnswer = true;
            _isCorrect = _selectedAnswer == _currentQuestion.CorrectAnswer;
            if (_isCorrect) _currentPrize = _currentQuestion.PrizeAmount;
        }
    }

    private void NextQuestion()
    {
        _currentQuestionIndex++;
        if (_currentQuestionIndex >= _gameQuestions.Count) _gameFinished = true;
        else LoadCurrentQuestion();
    }

    private void EndGame() => _gameFinished = true;

    private void ResetGame()
    {
        _isPlaying = false;
        _gameFinished = false;
        _currentQuestionIndex = 0;
        _currentQuestion = null;
        _selectedAnswer = null;
        _showAnswer = false;
        _currentPrize = 0;
    }

    private List<(string Label, string Text, CorrectOption Answer)> GetCurrentOptions() => _currentQuestion == null
        ? new List<(string, string, CorrectOption)>()
        : new List<(string, string, CorrectOption)> {
            ("A", _currentQuestion.OptionA, CorrectOption.A),
            ("B", _currentQuestion.OptionB, CorrectOption.B),
            ("C", _currentQuestion.OptionC, CorrectOption.C),
            ("D", _currentQuestion.OptionD, CorrectOption.D)
        };
}
