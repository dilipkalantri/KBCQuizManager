@page "/admin/questions"
@inject IAuthService AuthService
@inject IQuestionService QuestionService
@inject ICategoryService CategoryService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Questions - InternsHub</PageTitle>

<!-- Header -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 10px;">
    <div>
        <h1 style="color: white; font-size: 28px; margin: 0 0 8px 0;">Questions</h1>
        <p style="color: #9ca3af; margin: 0;">Manage your question bank by level (1-15)</p>
    </div>
    <button @onclick="OpenAddDialog" style="background: #7c3aed; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
        ‚ûï Add Question
    </button>
</div>

<!-- Level Summary -->
<div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        @for (int i = 1; i <= 15; i++)
        {
            var level = i;
            var count = _levelCounts.GetValueOrDefault(level, 0);
            var isSelected = _selectedLevel == level;
            <button @onclick="() => FilterByLevel(level)" 
                    style="padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: 1px solid @(isSelected ? "#7c3aed" : "#2a3f5f"); background: @(isSelected ? "#7c3aed" : "transparent"); color: @(count > 0 ? "white" : "#6b7280");">
                L@level <span style="color: @(count > 0 ? "#10b981" : "#ef4444");">(@count)</span>
            </button>
        }
        <button @onclick="() => FilterByLevel(null)" 
                style="padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: 1px solid @(_selectedLevel == null ? "#7c3aed" : "#2a3f5f"); background: @(_selectedLevel == null ? "#7c3aed" : "transparent"); color: white;">
            All (@_questions.Count)
        </button>
    </div>
</div>

<!-- Filters -->
<div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <input @bind="_searchString" @bind:event="oninput" placeholder="Search questions..." style="padding: 10px 15px; background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; color: white; font-size: 14px;" />
        <select @bind="_selectedCategoryId" style="padding: 10px 15px; background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; color: white; font-size: 14px;">
            <option value="">All Categories</option>
            @foreach (var cat in _categories)
            {
                <option value="@cat.Id">@cat.Name</option>
            }
        </select>
    </div>
</div>

@if (_isLoading)
{
    <div style="text-align: center; padding: 60px; color: #9ca3af;">Loading...</div>
}
else if (PagedQuestions.Any())
{
    <!-- Page info -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <span style="color: #9ca3af; font-size: 14px;">Showing @((_page - 1) * _pageSize + 1)-@(Math.Min(_page * _pageSize, FilteredCount)) of @FilteredCount questions</span>
    </div>

    <div style="display: flex; flex-direction: column; gap: 15px;">
        @foreach (var q in PagedQuestions)
        {
            <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 20px;">
                <!-- Question Header -->
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                    <p style="color: white; font-size: 16px; margin: 0; flex: 1; line-height: 1.5;">@q.QuestionText</p>
                    <div style="display: flex; gap: 5px; margin-left: 15px;">
                        <button @onclick="() => OpenEditDialog(q)" style="background: transparent; border: 1px solid #2a3f5f; color: #7c3aed; padding: 8px; border-radius: 6px; cursor: pointer;">‚úèÔ∏è</button>
                        <button @onclick="() => DeleteQuestion(q)" style="background: transparent; border: 1px solid #2a3f5f; color: #ef4444; padding: 8px; border-radius: 6px; cursor: pointer;">üóëÔ∏è</button>
                    </div>
                </div>
                
                <!-- Options -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    @foreach (var opt in new[] { ("A", q.OptionA, CorrectOption.A), ("B", q.OptionB, CorrectOption.B), ("C", q.OptionC, CorrectOption.C), ("D", q.OptionD, CorrectOption.D) })
                    {
                        var isCorrect = q.CorrectAnswer == opt.Item3;
                        <div style="padding: 12px 15px; border-radius: 8px; background: @(isCorrect ? "rgba(16, 185, 129, 0.15)" : "#1a1a2e"); border: 1px solid @(isCorrect ? "#10b981" : "#2a3f5f");">
                            <span style="color: @(isCorrect ? "#10b981" : "#9ca3af"); font-weight: 600; margin-right: 8px;">@opt.Item1.</span>
                            <span style="color: @(isCorrect ? "white" : "#9ca3af");">@opt.Item2</span>
                            @if (isCorrect) { <span style="color: #10b981; margin-left: 8px;">‚úì</span> }
                        </div>
                    }
                </div>
                
                <!-- Footer -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid #2a3f5f;">
                    <div style="display: flex; gap: 8px;">
                        <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: @GetLevelColor(q.Level); color: white;">Level @q.Level</span>
                        @if (q.Category != null)
                        {
                            <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; background: #2a3f5f; color: #7c3aed;">@q.Category.Name</span>
                        }
                    </div>
                    <span style="color: #fbbf24; font-size: 14px; font-weight: 600;">@KBCPrizeStructure.FormatPrize(q.GetPrizeAmount())</span>
                </div>
            </div>
        }
    </div>
    
    <!-- Pagination -->
    @if (TotalPages > 1)
    {
        <div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 25px; flex-wrap: wrap;">
            <button @onclick="() => GoToPage(_page - 1)" disabled="@(_page <= 1)" 
                    style="padding: 8px 14px; border-radius: 6px; border: 1px solid #2a3f5f; background: @(_page <= 1 ? "#1a1a2e" : "#16213e"); color: @(_page <= 1 ? "#4b5563" : "#9ca3af"); cursor: @(_page <= 1 ? "default" : "pointer"); font-size: 13px;">
                ‚Üê Prev
            </button>
            
            @for (int p = StartPage; p <= EndPage; p++)
            {
                var pageNum = p;
                <button @onclick="() => GoToPage(pageNum)" 
                        style="padding: 8px 14px; border-radius: 6px; border: 1px solid @(pageNum == _page ? "#7c3aed" : "#2a3f5f"); background: @(pageNum == _page ? "#7c3aed" : "#16213e"); color: white; cursor: pointer; font-size: 13px; font-weight: @(pageNum == _page ? "600" : "400");">
                    @pageNum
                </button>
            }
            
            <button @onclick="() => GoToPage(_page + 1)" disabled="@(_page >= TotalPages)" 
                    style="padding: 8px 14px; border-radius: 6px; border: 1px solid #2a3f5f; background: @(_page >= TotalPages ? "#1a1a2e" : "#16213e"); color: @(_page >= TotalPages ? "#4b5563" : "#9ca3af"); cursor: @(_page >= TotalPages ? "default" : "pointer"); font-size: 13px;">
                Next ‚Üí
            </button>
        </div>
    }
}
else
{
    <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 60px; text-align: center;">
        <div style="font-size: 64px; margin-bottom: 15px;">‚ùì</div>
        <h3 style="color: #9ca3af; font-size: 20px; margin: 0 0 10px 0;">No questions found</h3>
        <p style="color: #6b7280; margin: 0 0 20px 0;">Add questions for each level (1-15)</p>
        <button @onclick="OpenAddDialog" style="background: #7c3aed; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
            Add Question
        </button>
    </div>
}

<!-- Add/Edit Dialog -->
@if (_showDialog)
{
    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; overflow-y: auto; padding: 20px;">
        <div style="background: #16213e; border: 1px solid #2a3f5f; border-radius: 12px; padding: 25px; width: 700px; max-width: 95%;">
            <h2 style="color: white; font-size: 20px; margin: 0 0 20px 0;">@(_isEditMode ? "Edit Question" : "Add Question")</h2>
            
            <div style="margin-bottom: 15px;">
                <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 8px;">Question *</label>
                <textarea @bind="_editingQuestion.QuestionText" rows="3" style="width: 100%; padding: 12px; background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; color: white; font-size: 14px; resize: none;" placeholder="Enter question"></textarea>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 8px;">Option A *</label>
                    <input @bind="_editingQuestion.OptionA" style="width: 100%; padding: 10px; background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; color: white; font-size: 14px;" />
                </div>
                <div>
                    <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 8px;">Option B *</label>
                    <input @bind="_editingQuestion.OptionB" style="width: 100%; padding: 10px; background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; color: white; font-size: 14px;" />
                </div>
                <div>
                    <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 8px;">Option C *</label>
                    <input @bind="_editingQuestion.OptionC" style="width: 100%; padding: 10px; background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; color: white; font-size: 14px;" />
                </div>
                <div>
                    <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 8px;">Option D *</label>
                    <input @bind="_editingQuestion.OptionD" style="width: 100%; padding: 10px; background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; color: white; font-size: 14px;" />
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 8px;">Correct Answer</label>
                    <select @bind="_editingQuestion.CorrectAnswer" style="width: 100%; padding: 10px; background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; color: white; font-size: 14px;">
                        <option value="@CorrectOption.A">A</option>
                        <option value="@CorrectOption.B">B</option>
                        <option value="@CorrectOption.C">C</option>
                        <option value="@CorrectOption.D">D</option>
                    </select>
                </div>
                <div>
                    <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 8px;">Level (1-15) - Prize: @KBCPrizeStructure.FormatPrize(KBCPrizeStructure.LevelPrizes.GetValueOrDefault(_editingQuestion.Level, 1000))</label>
                    <select @bind="_editingQuestion.Level" style="width: 100%; padding: 10px; background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; color: white; font-size: 14px;">
                        @for (int i = 1; i <= 15; i++)
                        {
                            <option value="@i">Level @i - @KBCPrizeStructure.FormatPrize(KBCPrizeStructure.LevelPrizes[i])</option>
                        }
                    </select>
                </div>
                <div>
                    <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 8px;">Category</label>
                    <select @bind="_editingQuestion.CategoryId" style="width: 100%; padding: 10px; background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; color: white; font-size: 14px;">
                        @foreach (var cat in _categories)
                        {
                            <option value="@cat.Id">@cat.Name</option>
                        }
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 8px;">Hint/Explanation</label>
                <textarea @bind="_editingQuestion.Explanation" rows="2" style="width: 100%; padding: 10px; background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; color: white; font-size: 14px; resize: none;" placeholder="Optional hint"></textarea>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px;">
                <button @onclick="CloseDialog" style="background: transparent; border: 1px solid #2a3f5f; color: #9ca3af; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Cancel</button>
                <button @onclick="SaveQuestion" style="background: #7c3aed; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                    @(_isEditMode ? "Update" : "Create")
                </button>
            </div>
        </div>
    </div>
}

@code {
    private ApplicationUser? _currentUser;
    private List<Question> _questions = new();
    private List<Category> _categories = new();
    private Dictionary<int, int> _levelCounts = new();
    private bool _isLoading = true;
    private bool _showDialog = false;
    private bool _isEditMode = false;
    private Question _editingQuestion = new();
    private string _searchString = "";
    private string _selectedCategoryId = "";
    private int? _selectedLevel;
    private int _page = 1;
    private int _pageSize = 15;

    private IEnumerable<Question> FilteredQuestionsList => _questions.Where(q =>
        (string.IsNullOrEmpty(_searchString) || q.QuestionText.Contains(_searchString, StringComparison.OrdinalIgnoreCase)) &&
        (string.IsNullOrEmpty(_selectedCategoryId) || q.CategoryId.ToString() == _selectedCategoryId) &&
        (!_selectedLevel.HasValue || q.Level == _selectedLevel.Value));

    private int FilteredCount => FilteredQuestionsList.Count();
    private int TotalPages => (int)Math.Ceiling((double)FilteredCount / _pageSize);
    private int StartPage => Math.Max(1, _page - 2);
    private int EndPage => Math.Min(TotalPages, StartPage + 4);

    private IEnumerable<Question> PagedQuestions => FilteredQuestionsList
        .Skip((_page - 1) * _pageSize)
        .Take(_pageSize);

    protected override async Task OnInitializedAsync()
    {
        _currentUser = await AuthService.GetCurrentUserAsync();
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        if (_currentUser != null)
        {
            _questions = await QuestionService.GetQuestionsAsync(_currentUser.Id);
            _categories = await CategoryService.GetCategoriesAsync(_currentUser.Id);
            _levelCounts = await QuestionService.GetQuestionCountByLevelAsync(_currentUser.Id);
        }
        _isLoading = false;
    }

    private void FilterByLevel(int? level)
    {
        _selectedLevel = level;
        _page = 1; // Reset to first page on filter change
    }

    private void GoToPage(int page)
    {
        if (page >= 1 && page <= TotalPages) _page = page;
    }

    private void OpenAddDialog()
    {
        if (!_categories.Any())
        {
            Snackbar.Add("Create a category first", Severity.Warning);
            return;
        }
        _isEditMode = false;
        _editingQuestion = new Question { CategoryId = _categories.First().Id, Level = 1 };
        _showDialog = true;
    }

    private void OpenEditDialog(Question q)
    {
        _isEditMode = true;
        _editingQuestion = new Question
        {
            Id = q.Id, QuestionText = q.QuestionText, OptionA = q.OptionA, OptionB = q.OptionB,
            OptionC = q.OptionC, OptionD = q.OptionD, CorrectAnswer = q.CorrectAnswer,
            Level = q.Level, CategoryId = q.CategoryId, Explanation = q.Explanation, OwnerId = q.OwnerId
        };
        _showDialog = true;
    }

    private void CloseDialog()
    {
        _showDialog = false;
        _editingQuestion = new();
    }

    private async Task SaveQuestion()
    {
        if (string.IsNullOrWhiteSpace(_editingQuestion.QuestionText)) return;
        _editingQuestion.OwnerId = _currentUser!.Id;
        var (success, message) = _isEditMode
            ? await QuestionService.UpdateQuestionAsync(_editingQuestion, _currentUser.Id)
            : await QuestionService.CreateQuestionAsync(_editingQuestion);
        Snackbar.Add(message, success ? Severity.Success : Severity.Error);
        if (success) { CloseDialog(); await LoadData(); }
    }

    private async Task DeleteQuestion(Question q)
    {
        var confirm = await DialogService.ShowMessageBox("Delete Question", "Are you sure?", yesText: "Delete", cancelText: "Cancel");
        if (confirm == true)
        {
            var (success, message) = await QuestionService.DeleteQuestionAsync(q.Id, _currentUser!.Id);
            Snackbar.Add(message, success ? Severity.Success : Severity.Error);
            if (success) await LoadData();
        }
    }

    private string GetLevelColor(int level) => level switch
    {
        <= 5 => "#10b981",
        <= 10 => "#f59e0b",
        <= 13 => "#ef4444",
        _ => "#8b5cf6"
    };
}
