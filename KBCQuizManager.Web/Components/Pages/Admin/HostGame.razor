@page "/admin/multiplayer"
@page "/admin/multiplayer/host/{GameId:guid}"
@inject IAuthService AuthService
@inject IMultiplayerService MultiplayerService
@inject IQuestionService QuestionService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar
@implements IAsyncDisposable

<PageTitle>Host Multiplayer Game - KBC Quiz</PageTitle>

<audio id="soundCorrect" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundWrong" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2001/2001-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundTick" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundQuestion" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundWin" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundLifeline" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2570/2570-preview.mp3" type="audio/mpeg"></audio>

@if (_currentUser == null)
{
    <div style="text-align: center; padding: 50px; color: #9ca3af;">Loading...</div>
}
else if (_currentGame == null)
{
    <!-- Create Game Screen -->
    <div style="max-width: 700px; margin: 0 auto;">
        <h1 style="color: white; margin: 0 0 10px 0; font-size: 24px;">üéÆ Host Multiplayer Game</h1>
        <p style="color: #9ca3af; margin: 0 0 25px 0;">Create a room and invite players to join!</p>
        
        <div class="card" style="margin-bottom: 20px; padding: 25px;">
            <h3 style="color: white; margin: 0 0 20px 0;">Game Settings</h3>
            <div style="margin-bottom: 20px;">
                <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 8px;">Game Name</label>
                <input @bind="_gameName" placeholder="e.g., Class 10 Math Quiz" style="width: 100%; padding: 12px; background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; color: white; font-size: 16px;" />
            </div>
            <div class="settings-grid" style="margin-bottom: 20px;">
                <div>
                    <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 8px;">Max Players</label>
                    <select @bind="_maxPlayers" style="width: 100%; padding: 12px; background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; color: white;">
                        @foreach (var n in new[] { 10, 20, 30, 50 }) { <option value="@n">@n Players</option> }
                    </select>
                </div>
                <div>
                    <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 8px;">Time per Question</label>
                    <select @bind="_timePerQuestion" style="width: 100%; padding: 12px; background: #1a1a2e; border: 1px solid #2a3f5f; border-radius: 8px; color: white;">
                        @foreach (var t in new[] { 15, 20, 30, 45, 60 }) { <option value="@t">@t seconds</option> }
                    </select>
                </div>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="color: #9ca3af; font-size: 14px; display: block; margin-bottom: 8px;">Question Availability (15 Levels)</label>
                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                    @for (int i = 1; i <= 15; i++) { var lv = i; var c = _levelCounts.GetValueOrDefault(lv, 0);
                        <span style="padding: 4px 8px; border-radius: 6px; font-size: 11px; background: @(c > 0 ? "#10b981" : "#ef4444"); color: white;">L@(lv): @c</span> }
                </div>
                @if (_missingLevels.Any()) { <p style="color: #ef4444; font-size: 13px; margin: 8px 0 0;">‚ö†Ô∏è Missing: @string.Join(", ", _missingLevels)</p> }
            </div>
            <button @onclick="CreateGame" disabled="@(string.IsNullOrWhiteSpace(_gameName) || _missingLevels.Any() || _isCreating)"
                    style="width: 100%; padding: 14px; background: #7c3aed; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; opacity: @(string.IsNullOrWhiteSpace(_gameName) || _missingLevels.Any() || _isCreating ? "0.5" : "1");">
                @(_isCreating ? "Creating..." : "üéÆ Create Game Room")
            </button>
        </div>
        
        @if (_previousGames.Any())
        {
            <div class="card" style="padding: 25px;">
                <h3 style="color: white; margin: 0 0 15px 0;">Recent Games</h3>
                @foreach (var game in _previousGames.Take(5))
                {
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #1a1a2e; border-radius: 8px; margin-bottom: 6px; flex-wrap: wrap; gap: 8px;">
                        <div>
                            <span style="color: white; font-weight: 600;">@game.GameName</span>
                            <span style="color: #6b7280; font-size: 12px; margin-left: 8px;">@game.RoomCode</span>
                            <span style="color: #6b7280; font-size: 12px; margin-left: 8px;">@game.Players.Count players</span>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span style="padding: 3px 10px; border-radius: 12px; font-size: 11px; background: @GetStatusColor(game.Status); color: white;">@game.Status</span>
                            @if (game.Status == MultiplayerGameStatus.Waiting)
                            { <button @onclick="() => ResumeGame(game.Id)" style="padding: 5px 10px; background: #7c3aed; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Resume</button> }
                        </div>
                    </div>
                }
            </div>
        }
    </div>
}
else
{
    <!-- Game Host Control Panel -->
    <div class="game-container-wide">
        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
            <div>
                <h1 style="color: white; margin: 0; font-size: 22px;">@_currentGame.GameName</h1>
                <p style="color: #9ca3af; margin: 4px 0 0;">Room: <span style="color: #7c3aed; font-weight: 700; font-size: 22px; letter-spacing: 3px;">@_currentGame.RoomCode</span></p>
            </div>
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                <span style="padding: 6px 14px; border-radius: 20px; font-size: 13px; background: @GetStatusColor(_currentGame.Status); color: white;">@_currentGame.Status</span>
                @if (_currentGame.Status == MultiplayerGameStatus.Waiting)
                { <button @onclick="CopyJoinLink" style="padding: 6px 14px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px;">üìã Copy Link</button> }
            </div>
        </div>
        
        <div class="host-grid">
            <!-- Main Game Area -->
            <div>
                @if (_currentGame.Status == MultiplayerGameStatus.Waiting)
                {
                    <div class="card" style="padding: 35px; text-align: center;">
                        <div style="font-size: 60px; margin-bottom: 15px;">üë•</div>
                        <h2 style="color: white; margin: 0 0 8px;">Waiting for Players</h2>
                        <p style="color: #9ca3af; margin: 0 0 20px;">Share the room code or join link</p>
                        <div style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 25px;">
                            <p style="color: #6b7280; margin: 0 0 8px; font-size: 13px;">Join Link:</p>
                            <code style="color: #7c3aed; font-size: 13px; word-break: break-all;">@GetJoinLink()</code>
                        </div>
                        <button @onclick="StartGame" disabled="@(_players.Count(p => !p.IsHost) < 1)"
                                style="padding: 14px 35px; background: #10b981; color: white; border: none; border-radius: 10px; font-size: 17px; font-weight: 600; cursor: pointer; opacity: @(_players.Count(p => !p.IsHost) < 1 ? "0.5" : "1");">
                            ‚ñ∂Ô∏è Start Game (@_players.Count(p => !p.IsHost) players)
                        </button>
                    </div>
                }
                else if (_currentGame.Status == MultiplayerGameStatus.Starting)
                {
                    <div class="card" style="padding: 50px; text-align: center;">
                        <h2 style="color: white; margin: 0 0 15px;">Game Starting In...</h2>
                        <div style="font-size: 100px; color: #7c3aed; font-weight: 700;">@_countdown</div>
                    </div>
                }
                else if (_currentGame.Status == MultiplayerGameStatus.ShowingQuestion && _currentQuestion != null)
                {
                    <!-- Question + Host Answer UI -->
                    <div class="question-card" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 8px;">
                            <span style="background: #7c3aed; color: white; padding: 5px 12px; border-radius: 15px; font-size: 13px;">Q @_currentGame.CurrentQuestionIndex / @_currentGame.TotalQuestions</span>
                            <span style="color: #fbbf24; font-size: 16px; font-weight: 600;">@MultiplayerPoints.LevelPoints.GetValueOrDefault(_currentGame.CurrentQuestionIndex, 100) pts</span>
                        </div>
                        <h2 style="color: white; font-size: 20px; text-align: center; margin: 0 0 20px; line-height: 1.5;">@_currentQuestion.QuestionText</h2>
                        
                        <!-- Host can answer these options -->
                        <div class="grid-2col">
                            @foreach (var opt in new[] { ("A", _currentQuestion.OptionA), ("B", _currentQuestion.OptionB), ("C", _currentQuestion.OptionC), ("D", _currentQuestion.OptionD) })
                            {
                                var key = opt.Item1;
                                var isSelected = _hostSelectedAnswer == key;
                                var isHidden = _hostHiddenOptions.Contains(key);
                                var isDisabled = _hostHasAnswered || isHidden;
                                <button @onclick="() => HostSelectAnswer(key)" disabled="@isDisabled"
                                        class="option-btn @(isSelected ? "selected" : "") @(isHidden ? "hidden" : "")">
                                    <span style="color: #7c3aed; font-weight: 700; margin-right: 10px;">@key.</span>
                                    <span>@opt.Item2</span>
                                    @if (isSelected) { <span style="float: right; color: #7c3aed;">‚úì</span> }
                                </button>
                            }
                        </div>
                    </div>
                    
                    <!-- Host Lifelines + Lock Answer -->
                    @if (!_hostHasAnswered)
                    {
                        <div style="display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; justify-content: center;">
                            <button @onclick="HostUseFiftyFifty" disabled="@_hostFiftyFiftyUsed" class="lifeline-btn fifty">50:50</button>
                            <button @onclick="HostSkipQuestion" disabled="@_hostSkipUsed" class="lifeline-btn skip">‚è≠ Skip</button>
                            <button @onclick="HostUseDoubleDip" disabled="@(_hostDoubleDipUsed || _hostDoubleDipActive)" class="lifeline-btn double">üéØ Double Dip</button>
                            @if (_hostDoubleDipActive) { <span style="color: #a855f7; font-size: 13px; align-self: center;">Double Dip Active!</span> }
                        </div>
                        @if (_hostSelectedAnswer != null)
                        {
                            <div style="text-align: center; margin-bottom: 12px;">
                                <button @onclick="HostLockAnswer" style="padding: 12px 40px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; animation: glow 1.5s infinite;">
                                    üîí Lock My Answer
                                </button>
                            </div>
                        }
                    }
                    else
                    {
                        <div style="text-align: center; padding: 12px; background: rgba(124,58,237,0.1); border-radius: 10px; margin-bottom: 12px;">
                            <span style="color: #7c3aed;">‚úì Your answer locked!</span>
                        </div>
                    }
                    
                    <!-- Answer Stats Bar -->
                    <div class="card" style="margin-bottom: 12px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                            <span style="color: #9ca3af; font-size: 14px;">@_answeredCount / @_players.Count answered</span>
                            <div style="flex: 1; min-width: 100px; margin: 0 15px; background: #1a1a2e; border-radius: 10px; height: 6px;">
                                <div style="width: @(_players.Count > 0 ? (_answeredCount * 100 / _players.Count) : 0)%; background: #7c3aed; height: 100%; border-radius: 10px; transition: width 0.3s;"></div>
                            </div>
                            <span style="color: @(_timeRemaining <= 5 ? "#ef4444" : "#fbbf24"); font-size: 22px; font-weight: 700;">‚è±Ô∏è @_timeRemaining s</span>
                        </div>
                    </div>
                    
                    <button @onclick="RevealAnswer" style="width: 100%; padding: 14px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                        üîì Reveal Answer
                    </button>
                }
                else if (_currentGame.Status == MultiplayerGameStatus.ShowingAnswer && _currentQuestion != null)
                {
                    <!-- Answer Revealed -->
                    <div class="answer-card-correct" style="margin-bottom: 15px;">
                        <h2 style="color: white; font-size: 18px; text-align: center; margin: 0 0 18px;">@_currentQuestion.QuestionText</h2>
                        <div class="grid-2col" style="margin-bottom: 15px;">
                            @foreach (var opt in new[] { ("A", _currentQuestion.OptionA, CorrectOption.A), ("B", _currentQuestion.OptionB, CorrectOption.B), ("C", _currentQuestion.OptionC, CorrectOption.C), ("D", _currentQuestion.OptionD, CorrectOption.D) })
                            {
                                var isCorrect = opt.Item3 == _currentQuestion.CorrectAnswer;
                                var wasSelected = opt.Item1 == _hostSelectedAnswer;
                                <div class="option-btn @(isCorrect ? "correct" : wasSelected ? "wrong" : "")" style="cursor: default;">
                                    <span style="color: @(isCorrect ? "#10b981" : "#7c3aed"); font-weight: 700; margin-right: 10px;">@opt.Item1.</span> @opt.Item2
                                    @if (isCorrect) { <span style="float: right; color: #10b981;">‚úì</span> }
                                </div>
                            }
                        </div>
                        @if (!string.IsNullOrEmpty(_currentQuestion.Explanation))
                        {
                            <div style="background: rgba(59,130,246,0.1); border: 1px solid #3b82f6; border-radius: 8px; padding: 12px;">
                                <p style="color: #3b82f6; margin: 0; font-size: 13px;">üí° @_currentQuestion.Explanation</p>
                            </div>
                        }
                    </div>

                    <!-- Host result -->
                    @if (_hostWasCorrect.HasValue)
                    {
                        <div style="text-align: center; margin-bottom: 12px;">
                            <span style="background: @(_hostWasCorrect.Value ? "#10b981" : "#ef4444"); color: white; padding: 8px 20px; border-radius: 20px; font-size: 15px; font-weight: 600;">
                                @(_hostWasCorrect.Value ? $"‚úì You got it right! +{_hostPointsEarned}" : $"‚úó Wrong! {_hostPointsEarned} pts")
                            </span>
                        </div>
                    }
                    
                    <div style="display: flex; gap: 12px;">
                        <button @onclick="ShowLeaderboard" style="flex: 1; padding: 14px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">üèÜ Show Leaderboard</button>
                    </div>
                }
                else if (_currentGame.Status == MultiplayerGameStatus.ShowingLeaderboard)
                {
                    <div class="card" style="margin-bottom: 15px; padding: 25px;">
                        <h2 style="color: white; margin: 0 0 18px; text-align: center;">üèÜ Leaderboard</h2>
                        @foreach (var entry in _leaderboard.Take(15))
                        {
                            var medal = entry.Rank switch { 1 => "ü•á", 2 => "ü•à", 3 => "ü•â", _ => $"#{entry.Rank}" };
                            <div style="display: flex; align-items: center; padding: 10px 12px; background: @(entry.Rank <= 3 ? "rgba(124,58,237,0.1)" : "#1a1a2e"); border-radius: 8px; margin-bottom: 6px; flex-wrap: wrap; gap: 6px;">
                                <span style="width: 36px; font-size: @(entry.Rank <= 3 ? "18px" : "14px"); color: @(entry.Rank <= 3 ? "#fbbf24" : "#6b7280"); font-weight: 700;">@medal</span>
                                <span style="flex: 1; color: white; font-weight: 500; min-width: 80px;">@entry.PlayerName</span>
                                <span style="color: #10b981; font-size: 13px; margin-right: 10px;">@entry.CorrectAnswers‚úì</span>
                                <span style="color: #ef4444; font-size: 13px; margin-right: 10px;">@entry.WrongAnswers‚úó</span>
                                <span style="color: #9ca3af; font-size: 12px; margin-right: 10px;">@(entry.AverageTime > 0 ? $"{entry.AverageTime/1000.0:F1}s" : "-")</span>
                                <span style="color: #fbbf24; font-weight: 700; min-width: 70px; text-align: right;">@entry.TotalPoints.ToString("N0") pts</span>
                            </div>
                        }
                    </div>
                    <div style="display: flex; gap: 12px;">
                        @if (_currentGame.CurrentQuestionIndex < _currentGame.TotalQuestions)
                        { <button @onclick="NextQuestion" style="flex: 1; padding: 14px; background: #10b981; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">‚û°Ô∏è Next Question (@(_currentGame.CurrentQuestionIndex + 1)/@_currentGame.TotalQuestions)</button> }
                        else
                        { <button @onclick="EndGame" style="flex: 1; padding: 14px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">üèÅ End Game</button> }
                    </div>
                }
                else if (_currentGame.Status == MultiplayerGameStatus.Finished)
                {
                    <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #fbbf24; border-radius: 16px; padding: 35px; text-align: center;">
                        <div style="font-size: 60px; margin-bottom: 15px;">üèÜ</div>
                        <h1 style="color: #fbbf24; margin: 0 0 8px;">Game Complete!</h1>
                        @if (_leaderboard.Any()) { <p style="color: white; font-size: 22px; margin: 0 0 25px;">Winner: @_leaderboard.First().PlayerName</p> }
                        <div style="background: #1a1a2e; border-radius: 12px; padding: 20px; margin-bottom: 25px; text-align: left;">
                            <h3 style="color: white; margin: 0 0 12px; text-align: center;">Final Standings</h3>
                            @foreach (var e in _leaderboard)
                            {
                                <div style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #2a3f5f; flex-wrap: wrap; gap: 6px;">
                                    <span style="width: 36px; color: #7c3aed; font-weight: 700;">#@e.Rank</span>
                                    <span style="flex: 1; color: white; min-width: 80px;">@e.PlayerName</span>
                                    <span style="color: #9ca3af; font-size: 12px; margin-right: 10px;">@(e.AverageTime > 0 ? $"avg {e.AverageTime/1000.0:F1}s" : "")</span>
                                    <span style="color: #fbbf24; font-weight: 700;">@e.TotalPoints.ToString("N0") pts</span>
                                </div>
                            }
                        </div>
                        <button @onclick="CreateNewGame" style="padding: 14px 35px; background: #7c3aed; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">üéÆ New Game</button>
                    </div>
                }
                
                <!-- Live Leaderboard (always visible during game) -->
                @if (_currentGame.Status >= MultiplayerGameStatus.ShowingQuestion && _currentGame.Status < MultiplayerGameStatus.Finished && _liveLeaderboard.Any())
                {
                    <div class="live-lb" style="margin-top: 15px;">
                        <div class="live-lb-header" @onclick="() => _lbExpanded = !_lbExpanded">
                            <span style="color: white; font-weight: 600; font-size: 14px;">üìä Live Leaderboard</span>
                            <span style="color: #9ca3af; font-size: 12px;">@(_lbExpanded ? "‚ñ≤ Collapse" : "‚ñº Expand")</span>
                        </div>
                        @if (_lbExpanded)
                        {
                            <div class="live-lb-body">
                                @foreach (var e in _liveLeaderboard)
                                {
                                    var isMe = e.PlayerId == _hostPlayerId;
                                    <div class="lb-row @(isMe ? "me" : e.Rank <= 3 ? "top3" : "")">
                                        <span class="lb-rank" style="color: @(e.Rank <= 3 ? "#fbbf24" : "#6b7280");">@(e.Rank <= 3 ? (e.Rank == 1 ? "ü•á" : e.Rank == 2 ? "ü•à" : "ü•â") : $"#{e.Rank}")</span>
                                        <span class="lb-name">@e.PlayerName @(isMe ? "(You)" : "")</span>
                                        <span class="lb-stat" style="color: #10b981;">@e.CorrectAnswers‚úì</span>
                                        <span class="lb-stat">@(e.TotalTimeTaken > 0 ? $"{e.TotalTimeTaken/1000.0:F1}s" : "-")</span>
                                        <span class="lb-pts">@e.TotalPoints.ToString("N0")</span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
            
            <!-- Player List Sidebar -->
            <div class="card" style="height: fit-content; padding: 18px;">
                <h3 style="color: white; margin: 0 0 12px; font-size: 15px;">Players (@_players.Count(p => !p.IsHost) + Host)</h3>
                <div style="max-height: 400px; overflow-y: auto;">
                    @foreach (var player in _players.OrderByDescending(p => p.TotalPoints))
                    {
                        <div style="display: flex; align-items: center; padding: 8px; background: #1a1a2e; border-radius: 8px; margin-bottom: 5px;">
                            <div style="width: 8px; height: 8px; border-radius: 50%; background: @(player.IsConnected ? "#10b981" : "#ef4444"); margin-right: 8px; flex-shrink: 0;"></div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="color: white; font-size: 13px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@player.PlayerName</div>
                                <div style="color: #6b7280; font-size: 11px;">@player.TotalPoints pts</div>
                            </div>
                            @if (player.HasAnsweredCurrent && _currentGame.Status == MultiplayerGameStatus.ShowingQuestion)
                            { <span style="color: #10b981; font-size: 12px;">‚úì</span> }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

<style>
    @@keyframes glow { 0%,100% { box-shadow: 0 0 15px rgba(16,185,129,0.4); } 50% { box-shadow: 0 0 30px rgba(16,185,129,0.7); } }
</style>

@code {
    [Parameter] public Guid? GameId { get; set; }
    
    private ApplicationUser? _currentUser;
    private MultiplayerGame? _currentGame;
    private Question? _currentQuestion;
    private List<LeaderboardEntry> _leaderboard = new();
    private List<MultiplayerGame> _previousGames = new();
    private List<MultiplayerPlayer> _players = new();
    private Dictionary<int, int> _levelCounts = new();
    private List<int> _missingLevels = new();
    private Dictionary<string, int> _answerDistribution = new();
    
    private string _gameName = "";
    private int _maxPlayers = 50;
    private int _timePerQuestion = 30;
    private bool _isCreating = false;
    
    private int _countdown = 3;
    private int _timeRemaining = 30;
    private int _answeredCount = 0;
    
    // Host-as-player state
    private Guid _hostPlayerId;
    private string? _hostSelectedAnswer;
    private bool _hostHasAnswered = false;
    private bool _hostFiftyFiftyUsed = false;
    private bool _hostSkipUsed = false;
    private bool _hostDoubleDipUsed = false;
    private bool _hostDoubleDipActive = false;
    private List<string> _hostHiddenOptions = new();
    private bool? _hostWasCorrect;
    private int _hostPointsEarned = 0;
    
    // Live leaderboard
    private List<LiveLbEntry> _liveLeaderboard = new();
    private bool _lbExpanded = true;
    
    private HubConnection? _hubConnection;
    private System.Threading.Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _currentUser = await AuthService.GetCurrentUserAsync();
            if (_currentUser == null) { NavigationManager.NavigateTo("/login"); return; }
            
            _levelCounts = await QuestionService.GetQuestionCountByLevelAsync(_currentUser.Id);
            _missingLevels = Enumerable.Range(1, 15).Where(l => _levelCounts.GetValueOrDefault(l, 0) == 0).ToList();
            
            try { _previousGames = await MultiplayerService.GetHostGamesAsync(_currentUser.Id); }
            catch { _previousGames = new(); }
            
            if (GameId.HasValue)
            {
                _currentGame = await MultiplayerService.GetGameByIdAsync(GameId.Value);
                if (_currentGame != null)
                {
                    _players = _currentGame.Players.ToList();
                    await SetupSignalR();
                }
            }
        }
        catch (Exception ex) { Console.WriteLine($"Init error: {ex.Message}"); }
    }

    private async Task SetupSignalR()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/hubs/multiplayer"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<object>("PlayerListUpdated", async (_) =>
        {
            _currentGame = await MultiplayerService.GetGameByIdAsync(_currentGame!.Id);
            _players = _currentGame?.Players.ToList() ?? new();
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On<string>("PlayerJoined", async (name) =>
        {
            _currentGame = await MultiplayerService.GetGameByIdAsync(_currentGame!.Id);
            _players = _currentGame?.Players.ToList() ?? new();
            Snackbar.Add($"{name} joined!", Severity.Info);
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On<string>("PlayerDisconnected", async (name) =>
        {
            Snackbar.Add($"{name} disconnected", Severity.Warning);
            _currentGame = await MultiplayerService.GetGameByIdAsync(_currentGame!.Id);
            _players = _currentGame?.Players.ToList() ?? new();
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On<object>("PlayerAnswered", async (_) =>
        {
            _answeredCount++;
            _currentGame = await MultiplayerService.GetGameByIdAsync(_currentGame!.Id);
            _players = _currentGame?.Players.ToList() ?? new();
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On("AllPlayersAnswered", async () => await InvokeAsync(StateHasChanged));

        _hubConnection.On<Guid>("HostPlayerReady", async (playerId) =>
        {
            _hostPlayerId = playerId;
            // Load host's lifeline state
            var game = await MultiplayerService.GetGameByIdAsync(_currentGame!.Id);
            var hostPlayer = game?.Players.FirstOrDefault(p => p.Id == playerId);
            if (hostPlayer != null)
            {
                _hostFiftyFiftyUsed = hostPlayer.FiftyFiftyUsed;
                _hostSkipUsed = hostPlayer.SkipQuestionUsed;
                _hostDoubleDipUsed = hostPlayer.DoubleDipUsed;
            }
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On<List<string>>("FiftyFiftyResult", async (hidden) =>
        {
            _hostHiddenOptions = hidden;
            await PlaySound("soundLifeline");
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On("QuestionSkipped", async () =>
        {
            _hostHasAnswered = true;
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On<object>("DoubleDipResult", async (data) =>
        {
            var json = System.Text.Json.JsonSerializer.Serialize(data);
            var obj = System.Text.Json.JsonDocument.Parse(json);
            var isCorrect = obj.RootElement.GetProperty("isCorrect").GetBoolean();
            var answer = obj.RootElement.GetProperty("answer").GetString();
            
            if (isCorrect)
            {
                _hostHasAnswered = true;
            }
            else
            {
                // First attempt wrong - eliminate that option
                if (answer != null) _hostHiddenOptions.Add(answer);
                _hostSelectedAnswer = null;
            }
            await InvokeAsync(StateHasChanged);
        });

        // Live leaderboard updates
        _hubConnection.On<object>("LiveLeaderboard", async (data) =>
        {
            try
            {
                var json = System.Text.Json.JsonSerializer.Serialize(data);
                var arr = System.Text.Json.JsonDocument.Parse(json);
                _liveLeaderboard.Clear();
                foreach (var e in arr.RootElement.EnumerateArray())
                {
                    _liveLeaderboard.Add(new LiveLbEntry
                    {
                        Rank = e.GetProperty("rank").GetInt32(),
                        PlayerId = Guid.Parse(e.GetProperty("id").GetString()!),
                        PlayerName = e.GetProperty("playerName").GetString() ?? "",
                        TotalPoints = e.GetProperty("totalPoints").GetInt32(),
                        CorrectAnswers = e.GetProperty("correctAnswers").GetInt32(),
                        WrongAnswers = e.GetProperty("wrongAnswers").GetInt32(),
                        TotalTimeTaken = e.GetProperty("totalTimeTaken").GetInt32()
                    });
                }
                await InvokeAsync(StateHasChanged);
            }
            catch { }
        });

        // Answer revealed - find host's result
        _hubConnection.On<object>("AnswerRevealed", async (data) =>
        {
            try
            {
                var json = System.Text.Json.JsonSerializer.Serialize(data);
                var obj = System.Text.Json.JsonDocument.Parse(json);
                var results = obj.RootElement.GetProperty("playerResults");
                var hostIdStr = _hostPlayerId.ToString();
                foreach (var r in results.EnumerateArray())
                {
                    if (r.GetProperty("playerId").GetString() == hostIdStr)
                    {
                        _hostWasCorrect = r.GetProperty("isCorrect").GetBoolean();
                        _hostPointsEarned = r.GetProperty("pointsEarned").GetInt32();
                        break;
                    }
                }
            }
            catch { }
            await InvokeAsync(StateHasChanged);
        });

        await _hubConnection.StartAsync();
        await _hubConnection.InvokeAsync("JoinAsHost", _currentGame!.RoomCode, _currentUser!.FullName);
    }

    // ===== HOST ANSWER METHODS =====
    private void HostSelectAnswer(string answer)
    {
        if (_hostHasAnswered || _hostHiddenOptions.Contains(answer)) return;
        _hostSelectedAnswer = answer;
    }

    private async Task HostLockAnswer()
    {
        if (_hostSelectedAnswer == null || _hostHasAnswered || _hubConnection == null || _currentGame == null) return;
        
        if (_hostDoubleDipActive)
        {
            // Double dip first attempt
            await _hubConnection.InvokeAsync("DoubleDipCheck", _currentGame.Id, _hostPlayerId, _hostSelectedAnswer);
            _hostDoubleDipActive = false;
            return;
        }
        
        var timeTaken = (int)(DateTime.UtcNow - (_currentGame.QuestionStartedAt ?? DateTime.UtcNow)).TotalMilliseconds;
        await _hubConnection.InvokeAsync("SubmitAnswer", _currentGame.Id, _hostPlayerId, _hostSelectedAnswer, timeTaken, _hostHiddenOptions.Any());
        _hostHasAnswered = true;
        StateHasChanged();
    }

    private async Task HostUseFiftyFifty()
    {
        if (_hostFiftyFiftyUsed || _hostHasAnswered || _hubConnection == null || _currentGame == null) return;
        _hostFiftyFiftyUsed = true;
        await _hubConnection.InvokeAsync("UseFiftyFifty", _currentGame.Id, _hostPlayerId);
    }

    private async Task HostSkipQuestion()
    {
        if (_hostSkipUsed || _hostHasAnswered || _hubConnection == null || _currentGame == null) return;
        _hostSkipUsed = true;
        await _hubConnection.InvokeAsync("SkipQuestion", _currentGame.Id, _hostPlayerId);
    }

    private void HostUseDoubleDip()
    {
        if (_hostDoubleDipUsed || _hostHasAnswered) return;
        _hostDoubleDipUsed = true;
        _hostDoubleDipActive = true;
    }

    // ===== GAME CONTROL METHODS =====
    private async Task CreateGame()
    {
        if (_currentUser == null || string.IsNullOrWhiteSpace(_gameName)) return;
        _isCreating = true;
        try
        {
            _currentGame = await MultiplayerService.CreateGameAsync(_currentUser.Id, _gameName, _maxPlayers, _timePerQuestion);
            _players = new();
            NavigationManager.NavigateTo($"/admin/multiplayer/host/{_currentGame.Id}", forceLoad: true);
        }
        catch (Exception ex) { Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
        finally { _isCreating = false; }
    }

    private void ResumeGame(Guid gameId) => NavigationManager.NavigateTo($"/admin/multiplayer/host/{gameId}", forceLoad: true);

    private async Task StartGame()
    {
        if (_hubConnection == null || _currentGame == null || _players.Count(p => !p.IsHost) < 1) return;
        try
        {
            await _hubConnection.InvokeAsync("StartGame", _currentGame.Id);
            _currentGame.Status = MultiplayerGameStatus.Starting;
            await PlaySound("soundQuestion");
            _countdown = 3;
            StateHasChanged();
            _timer = new System.Threading.Timer(async _ =>
            {
                _countdown--;
                if (_countdown <= 0) { _timer?.Dispose(); await InvokeAsync(async () => await NextQuestion()); }
                else await InvokeAsync(StateHasChanged);
            }, null, 1000, 1000);
        }
        catch (Exception ex) { Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
    }

    private async Task NextQuestion()
    {
        if (_hubConnection == null || _currentGame == null) return;
        try
        {
            // Reset host answer state
            _hostSelectedAnswer = null;
            _hostHasAnswered = false;
            _hostHiddenOptions.Clear();
            _hostDoubleDipActive = false;
            _hostWasCorrect = null;
            _hostPointsEarned = 0;
            _answeredCount = 0;

            await _hubConnection.InvokeAsync("ShowNextQuestion", _currentGame.Id);
            await Task.Delay(300);
            _currentGame = await MultiplayerService.GetGameByIdAsync(_currentGame.Id);
            if (_currentGame == null) return;
            _players = _currentGame.Players.ToList();
            
            if (_currentGame.CurrentQuestionId != null)
                _currentQuestion = await QuestionService.GetByIdAsync(_currentGame.CurrentQuestionId.Value);
            if (_currentQuestion == null) { Snackbar.Add("Failed to load question", Severity.Error); return; }
            
            await PlaySound("soundQuestion");
            _timeRemaining = _currentGame.TimePerQuestion;
            _timer?.Dispose();
            _timer = new System.Threading.Timer(async _ =>
            {
                _timeRemaining--;
                if (_timeRemaining <= 5 && _timeRemaining > 0) await PlaySound("soundTick");
                if (_timeRemaining <= 0) _timer?.Dispose();
                await InvokeAsync(StateHasChanged);
            }, null, 1000, 1000);
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex) { Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
    }

    private async Task RevealAnswer()
    {
        if (_hubConnection == null || _currentGame == null) return;
        _timer?.Dispose();
        try
        {
            // Auto-submit host answer if not yet submitted
            if (!_hostHasAnswered && _hostSelectedAnswer != null)
                await HostLockAnswer();
            
            await _hubConnection.InvokeAsync("RevealAnswer", _currentGame.Id);
            _currentGame.Status = MultiplayerGameStatus.ShowingAnswer;
            _currentGame = await MultiplayerService.GetGameByIdAsync(_currentGame.Id);
            _players = _currentGame?.Players.ToList() ?? new();
            await PlaySound("soundCorrect");
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex) { Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
    }

    private async Task ShowLeaderboard()
    {
        if (_hubConnection == null || _currentGame == null) return;
        try
        {
            await _hubConnection.InvokeAsync("ShowLeaderboard", _currentGame.Id);
            _leaderboard = await MultiplayerService.GetLeaderboardAsync(_currentGame.Id);
            _currentGame.Status = MultiplayerGameStatus.ShowingLeaderboard;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex) { Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
    }

    private async Task EndGame()
    {
        if (_hubConnection == null || _currentGame == null) return;
        try
        {
            await _hubConnection.InvokeAsync("EndGame", _currentGame.Id);
            _leaderboard = await MultiplayerService.GetLeaderboardAsync(_currentGame.Id);
            _currentGame.Status = MultiplayerGameStatus.Finished;
            await PlaySound("soundWin");
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex) { Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
    }

    private void CreateNewGame() { _currentGame = null; _gameName = ""; NavigationManager.NavigateTo("/admin/multiplayer"); }
    private string GetJoinLink() => $"{NavigationManager.BaseUri}join/{_currentGame?.RoomCode}";
    
    private async Task CopyJoinLink()
    {
        try { await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", GetJoinLink()); Snackbar.Add("Link copied!", Severity.Success); }
        catch { Snackbar.Add("Could not copy", Severity.Warning); }
    }

    private async Task PlaySound(string id)
    {
        try { await JSRuntime.InvokeVoidAsync("eval", $"document.getElementById('{id}')?.play()"); } catch { }
    }

    private string GetStatusColor(MultiplayerGameStatus s) => s switch
    {
        MultiplayerGameStatus.Waiting => "#3b82f6",
        MultiplayerGameStatus.Starting => "#f59e0b",
        MultiplayerGameStatus.ShowingQuestion => "#7c3aed",
        MultiplayerGameStatus.ShowingAnswer => "#10b981",
        MultiplayerGameStatus.ShowingLeaderboard => "#8b5cf6",
        MultiplayerGameStatus.Finished => "#6b7280",
        _ => "#6b7280"
    };

    public async ValueTask DisposeAsync()
    {
        _timer?.Dispose();
        if (_hubConnection != null) await _hubConnection.DisposeAsync();
    }

    private class LiveLbEntry
    {
        public int Rank { get; set; }
        public Guid PlayerId { get; set; }
        public string PlayerName { get; set; } = "";
        public int TotalPoints { get; set; }
        public int CorrectAnswers { get; set; }
        public int WrongAnswers { get; set; }
        public int TotalTimeTaken { get; set; }
    }
}
