@page "/play/{RoomCode}"
@layout EmptyLayout
@inject IMultiplayerService MultiplayerService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Playing - InternSpark</PageTitle>

<audio id="soundCorrect" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundWrong" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2001/2001-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundTick" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundQuestion" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundWin" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundLifeline" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2570/2570-preview.mp3" type="audio/mpeg"></audio>

<link rel="stylesheet" href="css/app.css" />

<div style="min-height: 100vh; background: linear-gradient(180deg, #0a0a1a 0%, #1a1a2e 50%, #16213e 100%);">
    @if (_gameStatus == "Waiting" || _gameStatus == "Starting")
    {
        <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px;">
            <div style="text-align: center;">
                @if (_gameStatus == "Starting")
                {
                    <div style="font-size: 120px; color: #fbbf24; font-weight: 700; animation: pulse 0.5s infinite;">@_countdown</div>
                    <p style="color: #fbbf24; font-size: 22px;">Get Ready!</p>
                }
                else
                {
                    <div style="font-size: 60px; margin-bottom: 15px;">‚è≥</div>
                    <h2 style="color: white; font-size: 24px; margin: 0 0 8px;">Waiting for Game to Start</h2>
                    <p style="color: #9ca3af; margin: 0;">@_playerName - @_playerCount players in lobby</p>
                }
            </div>
        </div>
    }
    else if (_gameStatus == "ShowingQuestion")
    {
        <div class="game-container">
            <!-- Top Bar -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="background: #7c3aed; color: white; padding: 6px 14px; border-radius: 20px; font-weight: 600; font-size: 13px;">Q @_questionIndex / @_totalQuestions</span>
                    <span style="color: #fbbf24; font-weight: 600; font-size: 14px;">@_points pts</span>
                </div>
                <span style="color: @(_timeRemaining <= 5 ? "#ef4444" : "#9ca3af"); font-size: 28px; font-weight: 700; font-family: monospace;">@(_timeRemaining.ToString("00"))</span>
            </div>
            
            <!-- Timer Bar -->
            <div style="background: #1a1a2e; border-radius: 10px; height: 6px; margin-bottom: 20px; overflow: hidden;">
                <div style="width: @((_timeRemaining * 100.0 / _maxTime))%; background: @(_timeRemaining <= 5 ? "#ef4444" : _timeRemaining <= 10 ? "#f59e0b" : "#7c3aed"); height: 100%; transition: width 1s linear;"></div>
            </div>
            
            <!-- Question -->
            <div class="question-card" style="margin-bottom: 20px;">
                <h2 style="color: white; font-size: 20px; text-align: center; margin: 0; line-height: 1.5;">@_questionText</h2>
            </div>
            
            <!-- Options -->
            <div class="grid-2col" style="margin-bottom: 15px;">
                @foreach (var option in _options)
                {
                    var isSelected = _selectedAnswer == option.Key;
                    var isHidden = _hiddenOptions.Contains(option.Key);
                    var isDisabled = _hasAnswered || isHidden;
                    <button @onclick="() => SelectAnswer(option.Key)" disabled="@isDisabled"
                            class="option-btn @(isSelected ? "selected" : "") @(isHidden ? "hidden" : "")">
                        <span style="color: #7c3aed; font-weight: 700; margin-right: 10px; font-size: 16px;">@option.Key.</span>
                        <span>@option.Value</span>
                        @if (isSelected) { <span style="float: right; color: #7c3aed;">‚úì</span> }
                    </button>
                }
            </div>
            
            <!-- Lifelines -->
            @if (!_hasAnswered)
            {
                <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button @onclick="UseFiftyFifty" disabled="@_fiftyFiftyUsed" class="lifeline-btn fifty">50:50</button>
                    <button @onclick="UseSkipQuestion" disabled="@_skipUsed" class="lifeline-btn skip">‚è≠ Skip</button>
                    <button @onclick="UseDoubleDip" disabled="@(_doubleDipUsed || _doubleDipActive)" class="lifeline-btn double">üéØ Double Dip</button>
                    @if (_doubleDipActive) { <span style="color: #a855f7; font-size: 13px; align-self: center;">Double Dip Active!</span> }
                </div>
            }
            
            <!-- Lock Answer -->
            @if (_selectedAnswer != null && !_hasAnswered)
            {
                <div style="text-align: center; margin-bottom: 15px;">
                    <button @onclick="LockAnswer" style="padding: 14px 50px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 12px; font-size: 17px; font-weight: 600; cursor: pointer; animation: glow 1.5s infinite;">
                        üîí Lock Answer
                    </button>
                </div>
            }
            
            @if (_hasAnswered)
            {
                <div style="text-align: center; padding: 15px; background: rgba(124,58,237,0.1); border-radius: 10px; margin-bottom: 15px;">
                    <span style="color: #7c3aed; font-size: 16px;">@(_skipped ? "‚è≠ Question Skipped!" : "‚úì Answer Locked! Waiting...")</span>
                </div>
            }
            
            <!-- Player Stats -->
            <div class="stats-row" style="padding: 12px; background: #16213e; border-radius: 12px; margin-bottom: 15px;">
                <div style="text-align: center; min-width: 70px;">
                    <div style="color: #6b7280; font-size: 11px;">Points</div>
                    <div style="color: #fbbf24; font-size: 22px; font-weight: 700;">@_totalPoints.ToString("N0")</div>
                </div>
                <div style="text-align: center; min-width: 50px;">
                    <div style="color: #6b7280; font-size: 11px;">Correct</div>
                    <div style="color: #10b981; font-size: 22px; font-weight: 700;">@_correctCount</div>
                </div>
                <div style="text-align: center; min-width: 50px;">
                    <div style="color: #6b7280; font-size: 11px;">Wrong</div>
                    <div style="color: #ef4444; font-size: 22px; font-weight: 700;">@_wrongCount</div>
                </div>
            </div>
            
            <!-- Live Leaderboard -->
            @if (_liveLeaderboard.Any())
            {
                <div class="live-lb">
                    <div class="live-lb-header" @onclick="() => _lbOpen = !_lbOpen">
                        <span style="color: white; font-weight: 600; font-size: 14px;">üìä Live Leaderboard @(_myRank > 0 ? $"(You: #{_myRank})" : "")</span>
                        <span style="color: #9ca3af; font-size: 12px;">@(_lbOpen ? "‚ñ≤" : "‚ñº")</span>
                    </div>
                    @if (_lbOpen)
                    {
                        <div class="live-lb-body">
                            @foreach (var e in _liveLeaderboard)
                            {
                                var isMe = e.PlayerId == _playerId;
                                <div class="lb-row @(isMe ? "me" : e.Rank <= 3 ? "top3" : "")">
                                    <span class="lb-rank" style="color: @(e.Rank <= 3 ? "#fbbf24" : "#6b7280");">@(e.Rank <= 3 ? (e.Rank == 1 ? "ü•á" : e.Rank == 2 ? "ü•à" : "ü•â") : $"#{e.Rank}")</span>
                                    <span class="lb-name">@e.PlayerName @(isMe ? "(You)" : "")</span>
                                    <span class="lb-stat" style="color: #10b981;">@e.CorrectAnswers‚úì</span>
                                    <span class="lb-stat">@(e.TotalTimeTaken > 0 ? $"{e.TotalTimeTaken/1000.0:F1}s" : "-")</span>
                                    <span class="lb-pts">@e.TotalPoints.ToString("N0")</span>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    }
    else if (_gameStatus == "ShowingAnswer")
    {
        <div class="game-container">
            <div style="text-align: center; margin-bottom: 15px;">
                <span style="background: @(_wasCorrect ? "#10b981" : _skipped ? "#3b82f6" : "#ef4444"); color: white; padding: 8px 22px; border-radius: 25px; font-size: 18px; font-weight: 600;">
                    @(_skipped ? "‚è≠ Skipped" : _wasCorrect ? $"‚úì Correct! +{_pointsEarned} pts" : $"‚úó Wrong! {_pointsEarned} pts")
                </span>
            </div>
            
            <div class="@(_wasCorrect ? "answer-card-correct" : "answer-card-wrong")" style="margin-bottom: 20px;">
                <h2 style="color: white; font-size: 18px; text-align: center; margin: 0 0 18px;">@_questionText</h2>
                <div class="grid-2col">
                    @foreach (var option in _options)
                    {
                        var isCorrect = option.Key == _correctAnswer;
                        var wasSelected = option.Key == _selectedAnswer;
                        <div class="option-btn @(isCorrect ? "correct" : wasSelected && !isCorrect ? "wrong" : "")" style="cursor: default;">
                            <span style="color: @(isCorrect ? "#10b981" : "#7c3aed"); font-weight: 700; margin-right: 10px;">@option.Key.</span>
                            <span style="color: white;">@option.Value</span>
                            @if (isCorrect) { <span style="float: right; color: #10b981;">‚úì</span> }
                            @if (wasSelected && !isCorrect) { <span style="float: right; color: #ef4444;">‚úó</span> }
                        </div>
                    }
                </div>
            </div>
            
            @if (!string.IsNullOrEmpty(_explanation))
            {
                <div style="background: rgba(59,130,246,0.1); border: 1px solid #3b82f6; border-radius: 10px; padding: 12px; margin-bottom: 15px;">
                    <p style="color: #3b82f6; margin: 0; font-size: 14px;">üí° @_explanation</p>
                </div>
            }
            
            <div style="text-align: center; color: #9ca3af; margin-bottom: 15px;">Waiting for next question...</div>
            
            <!-- Live Leaderboard -->
            @if (_liveLeaderboard.Any())
            {
                <div class="live-lb">
                    <div class="live-lb-header" @onclick="() => _lbOpen = !_lbOpen">
                        <span style="color: white; font-weight: 600; font-size: 14px;">üìä Leaderboard @(_myRank > 0 ? $"(You: #{_myRank})" : "")</span>
                        <span style="color: #9ca3af; font-size: 12px;">@(_lbOpen ? "‚ñ≤" : "‚ñº")</span>
                    </div>
                    @if (_lbOpen)
                    {
                        <div class="live-lb-body">
                            @foreach (var e in _liveLeaderboard)
                            {
                                var isMe = e.PlayerId == _playerId;
                                <div class="lb-row @(isMe ? "me" : e.Rank <= 3 ? "top3" : "")">
                                    <span class="lb-rank" style="color: @(e.Rank <= 3 ? "#fbbf24" : "#6b7280");">@(e.Rank <= 3 ? (e.Rank == 1 ? "ü•á" : e.Rank == 2 ? "ü•à" : "ü•â") : $"#{e.Rank}")</span>
                                    <span class="lb-name">@e.PlayerName @(isMe ? "(You)" : "")</span>
                                    <span class="lb-stat" style="color: #10b981;">@e.CorrectAnswers‚úì</span>
                                    <span class="lb-stat">@(e.TotalTimeTaken > 0 ? $"{e.TotalTimeTaken/1000.0:F1}s" : "-")</span>
                                    <span class="lb-pts">@e.TotalPoints.ToString("N0")</span>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    }
    else if (_gameStatus == "ShowingLeaderboard")
    {
        <div class="game-container" style="max-width: 700px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <h1 style="color: #fbbf24; font-size: 28px; margin: 0;">üèÜ Leaderboard</h1>
                <p style="color: #9ca3af; margin: 5px 0 0;">After Question @_questionIndex of @_totalQuestions</p>
            </div>
            <div class="card" style="padding: 16px;">
                @foreach (var entry in _leaderboard)
                {
                    var isMe = entry.PlayerId == _playerId;
                    var medal = entry.Rank switch { 1 => "ü•á", 2 => "ü•à", 3 => "ü•â", _ => $"#{entry.Rank}" };
                    <div style="display: flex; align-items: center; padding: 12px; background: @(isMe ? "rgba(124,58,237,0.2)" : entry.Rank <= 3 ? "rgba(251,191,36,0.1)" : "#1a1a2e"); border-radius: 10px; margin-bottom: 8px; border: @(isMe ? "2px solid #7c3aed" : "none"); flex-wrap: wrap; gap: 6px;">
                        <span style="width: 42px; font-size: @(entry.Rank <= 3 ? "22px" : "14px"); color: @(entry.Rank <= 3 ? "#fbbf24" : "#6b7280"); font-weight: 700;">@medal</span>
                        <span style="flex: 1; color: white; font-weight: @(isMe ? "700" : "500"); min-width: 80px;">@entry.PlayerName @(isMe ? "(You)" : "")</span>
                        <span style="color: #10b981; font-size: 13px; margin-right: 12px;">@entry.CorrectAnswers ‚úì</span>
                        <span style="color: #9ca3af; font-size: 12px; margin-right: 12px;">@(entry.TotalTimeTaken > 0 ? $"{entry.TotalTimeTaken/1000.0:F1}s" : "-")</span>
                        <span style="color: #fbbf24; font-weight: 700; min-width: 80px; text-align: right;">@entry.TotalPoints.ToString("N0") pts</span>
                    </div>
                }
            </div>
        </div>
    }
    else if (_gameStatus == "Finished")
    {
        <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px;">
            <div style="max-width: 550px; width: 100%; text-align: center;">
                <div style="font-size: 80px; margin-bottom: 15px;">üèÜ</div>
                <h1 style="color: #fbbf24; font-size: 30px; margin: 0 0 8px;">Game Over!</h1>
                @if (_myRank == 1) { <p style="color: #10b981; font-size: 22px; margin: 0 0 25px;">üéâ You Won! üéâ</p> }
                else { <p style="color: white; font-size: 18px; margin: 0 0 25px;">You finished #@_myRank</p> }
                
                <div class="card" style="margin-bottom: 20px; padding: 20px;">
                    <div class="stats-row">
                        <div style="text-align: center; min-width: 70px;">
                            <div style="color: #6b7280; font-size: 13px; margin-bottom: 4px;">Score</div>
                            <div style="color: #fbbf24; font-size: 28px; font-weight: 700;">@_totalPoints.ToString("N0")</div>
                        </div>
                        <div style="text-align: center; min-width: 50px;">
                            <div style="color: #6b7280; font-size: 13px; margin-bottom: 4px;">Correct</div>
                            <div style="color: #10b981; font-size: 28px; font-weight: 700;">@_correctCount</div>
                        </div>
                        <div style="text-align: center; min-width: 50px;">
                            <div style="color: #6b7280; font-size: 13px; margin-bottom: 4px;">Wrong</div>
                            <div style="color: #ef4444; font-size: 28px; font-weight: 700;">@_wrongCount</div>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="padding: 16px; text-align: left; margin-bottom: 25px;">
                    <h3 style="color: white; margin: 0 0 12px; text-align: center;">Final Standings</h3>
                    @foreach (var entry in _leaderboard.Take(10))
                    {
                        var isMe = entry.PlayerId == _playerId;
                        <div style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #2a3f5f; flex-wrap: wrap; gap: 4px;">
                            <span style="width: 36px; color: #7c3aed; font-weight: 700;">#@entry.Rank</span>
                            <span style="flex: 1; color: @(isMe ? "#7c3aed" : "white"); font-weight: @(isMe ? "700" : "400"); min-width: 60px;">@entry.PlayerName</span>
                            <span style="color: #9ca3af; font-size: 12px; margin-right: 8px;">@(entry.TotalTimeTaken > 0 ? $"{entry.TotalTimeTaken/1000.0:F1}s" : "")</span>
                            <span style="color: #fbbf24; font-weight: 700;">@entry.TotalPoints.ToString("N0")</span>
                        </div>
                    }
                </div>
                
                <button onclick="location.href='/join'" style="padding: 14px 35px; background: #7c3aed; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer;">Play Again</button>
            </div>
        </div>
    }
</div>

<style>
    @@keyframes glow { 0%,100% { box-shadow: 0 0 15px rgba(16,185,129,0.4); } 50% { box-shadow: 0 0 30px rgba(16,185,129,0.7); } }
    @@keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.08); } }
</style>

@code {
    [Parameter] public string RoomCode { get; set; } = "";
    [SupplyParameterFromQuery] public string? PlayerId { get; set; }
    
    private HubConnection? _hubConnection;
    private Guid _playerId;
    private Guid _gameId;
    private string _playerName = "";
    private int _playerCount = 0;
    
    private string _gameStatus = "Waiting";
    private int _countdown = 3;
    private int _questionIndex = 0;
    private int _totalQuestions = 15;
    private int _points = 0;
    private int _maxTime = 30;
    private int _timeRemaining = 30;
    private DateTime _questionStartTime;
    
    private string _questionText = "";
    private Dictionary<string, string> _options = new();
    private string? _selectedAnswer;
    private string? _correctAnswer;
    private string _explanation = "";
    private bool _hasAnswered = false;
    private bool _wasCorrect = false;
    private bool _skipped = false;
    private int _pointsEarned = 0;
    
    // Lifelines
    private List<string> _hiddenOptions = new();
    private bool _fiftyFiftyUsed = false;
    private bool _skipUsed = false;
    private bool _doubleDipUsed = false;
    private bool _doubleDipActive = false;
    
    // Stats
    private int _totalPoints = 0;
    private int _correctCount = 0;
    private int _wrongCount = 0;
    private int _myRank = 0;
    
    // Leaderboard
    private List<LbEntry> _leaderboard = new();
    private List<LbEntry> _liveLeaderboard = new();
    private bool _lbOpen = true;
    
    private System.Threading.Timer? _timer;
    private bool _soundEnabled = true;

    protected override async Task OnInitializedAsync()
    {
        if (!Guid.TryParse(PlayerId, out _playerId)) { NavigationManager.NavigateTo("/join"); return; }
        
        var game = await MultiplayerService.GetGameByRoomCodeAsync(RoomCode);
        if (game != null)
        {
            _gameId = game.Id;
            var player = game.Players.FirstOrDefault(p => p.Id == _playerId);
            if (player != null)
            {
                _playerName = player.PlayerName;
                _totalPoints = player.TotalPoints;
                _correctCount = player.CorrectAnswers;
                _wrongCount = player.WrongAnswers;
                _fiftyFiftyUsed = player.FiftyFiftyUsed;
                _skipUsed = player.SkipQuestionUsed;
                _doubleDipUsed = player.DoubleDipUsed;
            }
        }
        
        if (string.IsNullOrEmpty(_playerName)) { NavigationManager.NavigateTo("/join"); return; }
        await SetupSignalR();
    }

    private async Task SetupSignalR()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/hubs/multiplayer"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<object>("PlayerListUpdated", async (players) =>
        {
            try
            {
                var json = System.Text.Json.JsonSerializer.Serialize(players);
                var arr = System.Text.Json.JsonDocument.Parse(json);
                _playerCount = arr.RootElement.GetArrayLength();
                await InvokeAsync(StateHasChanged);
            }
            catch { }
        });

        _hubConnection.On<int>("GameStarting", async (countdown) =>
        {
            _gameStatus = "Starting"; _countdown = countdown;
            await PlaySound("soundQuestion");
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On<object>("QuestionRevealed", async (data) =>
        {
            try
            {
                var json = System.Text.Json.JsonSerializer.Serialize(data);
                var obj = System.Text.Json.JsonDocument.Parse(json);
                
                _questionIndex = obj.RootElement.GetProperty("questionIndex").GetInt32();
                _totalQuestions = obj.RootElement.GetProperty("totalQuestions").GetInt32();
                _questionText = obj.RootElement.GetProperty("questionText").GetString() ?? "";
                _points = obj.RootElement.GetProperty("points").GetInt32();
                _maxTime = obj.RootElement.GetProperty("timeLimit").GetInt32();
                _timeRemaining = _maxTime;
                
                _options = new Dictionary<string, string>
                {
                    { "A", obj.RootElement.GetProperty("optionA").GetString() ?? "" },
                    { "B", obj.RootElement.GetProperty("optionB").GetString() ?? "" },
                    { "C", obj.RootElement.GetProperty("optionC").GetString() ?? "" },
                    { "D", obj.RootElement.GetProperty("optionD").GetString() ?? "" }
                };
                
                _selectedAnswer = null; _hasAnswered = false; _skipped = false;
                _wasCorrect = false; _pointsEarned = 0;
                _hiddenOptions.Clear(); _doubleDipActive = false;
                _gameStatus = "ShowingQuestion";
                _questionStartTime = DateTime.UtcNow;
                
                await PlaySound("soundQuestion");
                StartTimer();
                await InvokeAsync(StateHasChanged);
            }
            catch { }
        });

        _hubConnection.On<object>("AnswerRevealed", async (data) =>
        {
            try
            {
                _timer?.Dispose();
                var json = System.Text.Json.JsonSerializer.Serialize(data);
                var obj = System.Text.Json.JsonDocument.Parse(json);
                
                _correctAnswer = obj.RootElement.GetProperty("correctAnswer").GetString();
                _explanation = obj.RootElement.TryGetProperty("explanation", out var exp) ? exp.GetString() ?? "" : "";
                
                var myIdStr = _playerId.ToString();
                var results = obj.RootElement.GetProperty("playerResults");
                bool foundResult = false;
                foreach (var result in results.EnumerateArray())
                {
                    if (result.GetProperty("playerId").GetString() == myIdStr)
                    {
                        _wasCorrect = result.GetProperty("isCorrect").GetBoolean();
                        _pointsEarned = result.GetProperty("pointsEarned").GetInt32();
                        _skipped = result.TryGetProperty("usedSkip", out var skip) && skip.GetBoolean();
                        _totalPoints += _pointsEarned;
                        if (!_skipped) { if (_wasCorrect) _correctCount++; else _wrongCount++; }
                        foundResult = true;
                        break;
                    }
                }
                
                if (!foundResult && _selectedAnswer != null && _correctAnswer != null)
                    _wasCorrect = _selectedAnswer == _correctAnswer;
                
                await PlaySound(_wasCorrect ? "soundCorrect" : "soundWrong");
                _gameStatus = "ShowingAnswer";
                await InvokeAsync(StateHasChanged);
            }
            catch { _gameStatus = "ShowingAnswer"; await InvokeAsync(StateHasChanged); }
        });

        _hubConnection.On<object>("LeaderboardUpdated", async (data) =>
        {
            try
            {
                var json = System.Text.Json.JsonSerializer.Serialize(data);
                var obj = System.Text.Json.JsonDocument.Parse(json);
                _leaderboard.Clear();
                foreach (var e in obj.RootElement.GetProperty("leaderboard").EnumerateArray())
                {
                    var lb = new LbEntry
                    {
                        Rank = e.GetProperty("rank").GetInt32(),
                        PlayerId = Guid.Parse(e.GetProperty("id").GetString()!),
                        PlayerName = e.GetProperty("playerName").GetString() ?? "",
                        TotalPoints = e.GetProperty("totalPoints").GetInt32(),
                        CorrectAnswers = e.GetProperty("correctAnswers").GetInt32(),
                        TotalTimeTaken = e.GetProperty("totalTimeTaken").GetInt32()
                    };
                    _leaderboard.Add(lb);
                    if (lb.PlayerId == _playerId) _myRank = lb.Rank;
                }
                _gameStatus = "ShowingLeaderboard";
                await InvokeAsync(StateHasChanged);
            }
            catch { }
        });

        _hubConnection.On<object>("GameEnded", async (data) =>
        {
            try
            {
                var json = System.Text.Json.JsonSerializer.Serialize(data);
                var obj = System.Text.Json.JsonDocument.Parse(json);
                _leaderboard.Clear();
                foreach (var e in obj.RootElement.GetProperty("finalLeaderboard").EnumerateArray())
                {
                    var lb = new LbEntry
                    {
                        Rank = e.GetProperty("rank").GetInt32(),
                        PlayerId = Guid.Parse(e.GetProperty("id").GetString()!),
                        PlayerName = e.GetProperty("playerName").GetString() ?? "",
                        TotalPoints = e.GetProperty("totalPoints").GetInt32(),
                        CorrectAnswers = e.GetProperty("correctAnswers").GetInt32(),
                        TotalTimeTaken = e.GetProperty("totalTimeTaken").GetInt32()
                    };
                    _leaderboard.Add(lb);
                    if (lb.PlayerId == _playerId) _myRank = lb.Rank;
                }
                await PlaySound(_myRank == 1 ? "soundWin" : "soundQuestion");
                _gameStatus = "Finished";
                await InvokeAsync(StateHasChanged);
            }
            catch { }
        });

        // Live leaderboard
        _hubConnection.On<object>("LiveLeaderboard", async (data) =>
        {
            try
            {
                var json = System.Text.Json.JsonSerializer.Serialize(data);
                var arr = System.Text.Json.JsonDocument.Parse(json);
                _liveLeaderboard.Clear();
                foreach (var e in arr.RootElement.EnumerateArray())
                {
                    var lb = new LbEntry
                    {
                        Rank = e.GetProperty("rank").GetInt32(),
                        PlayerId = Guid.Parse(e.GetProperty("id").GetString()!),
                        PlayerName = e.GetProperty("playerName").GetString() ?? "",
                        TotalPoints = e.GetProperty("totalPoints").GetInt32(),
                        CorrectAnswers = e.GetProperty("correctAnswers").GetInt32(),
                        WrongAnswers = e.GetProperty("wrongAnswers").GetInt32(),
                        TotalTimeTaken = e.GetProperty("totalTimeTaken").GetInt32()
                    };
                    _liveLeaderboard.Add(lb);
                    if (lb.PlayerId == _playerId) _myRank = lb.Rank;
                }
                await InvokeAsync(StateHasChanged);
            }
            catch { }
        });

        // Lifeline responses
        _hubConnection.On<List<string>>("FiftyFiftyResult", async (hidden) =>
        {
            _hiddenOptions = hidden;
            await PlaySound("soundLifeline");
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On("QuestionSkipped", async () =>
        {
            _hasAnswered = true; _skipped = true;
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On<object>("DoubleDipResult", async (data) =>
        {
            var json = System.Text.Json.JsonSerializer.Serialize(data);
            var obj = System.Text.Json.JsonDocument.Parse(json);
            var isCorrect = obj.RootElement.GetProperty("isCorrect").GetBoolean();
            var answer = obj.RootElement.GetProperty("answer").GetString();
            
            if (isCorrect)
            {
                _hasAnswered = true;
            }
            else
            {
                if (answer != null) _hiddenOptions.Add(answer);
                _selectedAnswer = null;
                _doubleDipActive = false;
            }
            await InvokeAsync(StateHasChanged);
        });

        await _hubConnection.StartAsync();
        await _hubConnection.InvokeAsync("Reconnect", _playerId, RoomCode);
    }

    private void StartTimer()
    {
        _timer?.Dispose();
        _timer = new System.Threading.Timer(async _ =>
        {
            _timeRemaining--;
            if (_timeRemaining <= 5 && _timeRemaining > 0) await PlaySound("soundTick");
            if (_timeRemaining <= 0)
            {
                _timer?.Dispose();
                if (!_hasAnswered) await SubmitAnswer(null);
            }
            await InvokeAsync(StateHasChanged);
        }, null, 1000, 1000);
    }

    private void SelectAnswer(string answer)
    {
        if (_hasAnswered || _hiddenOptions.Contains(answer)) return;
        _selectedAnswer = answer;
    }

    private async Task LockAnswer()
    {
        if (_selectedAnswer == null || _hasAnswered) return;
        
        if (_doubleDipActive)
        {
            // Double dip first attempt
            if (_hubConnection != null && _gameId != Guid.Empty)
                await _hubConnection.InvokeAsync("DoubleDipCheck", _gameId, _playerId, _selectedAnswer);
            return;
        }
        
        await SubmitAnswer(_selectedAnswer);
    }

    private async Task SubmitAnswer(string? answer)
    {
        if (_hasAnswered) return;
        _hasAnswered = true;
        var timeTaken = (int)(DateTime.UtcNow - _questionStartTime).TotalMilliseconds;
        var usedLifeline = _hiddenOptions.Any() || _doubleDipUsed;
        if (_hubConnection != null && _gameId != Guid.Empty)
            await _hubConnection.InvokeAsync("SubmitAnswer", _gameId, _playerId, answer, timeTaken, usedLifeline);
        StateHasChanged();
    }

    private async Task UseFiftyFifty()
    {
        if (_fiftyFiftyUsed || _hasAnswered) return;
        _fiftyFiftyUsed = true;
        if (_hubConnection != null && _gameId != Guid.Empty)
            await _hubConnection.InvokeAsync("UseFiftyFifty", _gameId, _playerId);
    }

    private async Task UseSkipQuestion()
    {
        if (_skipUsed || _hasAnswered) return;
        _skipUsed = true;
        if (_hubConnection != null && _gameId != Guid.Empty)
            await _hubConnection.InvokeAsync("SkipQuestion", _gameId, _playerId);
    }

    private void UseDoubleDip()
    {
        if (_doubleDipUsed || _hasAnswered) return;
        _doubleDipUsed = true;
        _doubleDipActive = true;
    }

    private async Task PlaySound(string id)
    {
        if (!_soundEnabled) return;
        try { await JSRuntime.InvokeVoidAsync("eval", $"document.getElementById('{id}')?.play()"); } catch { }
    }

    public async ValueTask DisposeAsync()
    {
        _timer?.Dispose();
        if (_hubConnection != null) await _hubConnection.DisposeAsync();
    }
    
    private class LbEntry
    {
        public int Rank { get; set; }
        public Guid PlayerId { get; set; }
        public string PlayerName { get; set; } = "";
        public int TotalPoints { get; set; }
        public int CorrectAnswers { get; set; }
        public int WrongAnswers { get; set; }
        public int TotalTimeTaken { get; set; }
    }
}
