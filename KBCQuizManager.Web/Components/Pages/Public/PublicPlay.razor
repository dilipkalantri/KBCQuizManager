@page "/play-solo"
@layout EmptyLayout
@inject IUserService UserService
@inject ICategoryService CategoryService
@inject IQuestionService QuestionService
@inject IGameService GameService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Play Solo - InternSpark</PageTitle>

<MudThemeProvider IsDarkMode="true" />

<!-- Sound Elements -->
<audio id="soundCorrect" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundWrong" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2001/2001-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundQuestion" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundWin" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" type="audio/mpeg"></audio>
<audio id="soundLevelUp" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" type="audio/mpeg"></audio>

<style>
    body { margin: 0; }
    .sp-page { min-height: 100vh; background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%); font-family: 'Roboto', Arial, sans-serif; }
    .sp-center { max-width: 550px; margin: 0 auto; padding: 20px; }
    .sp-wide { max-width: 950px; margin: 0 auto; padding: 20px; }
    .sp-logo { text-align: center; padding: 20px 0 10px; }
    .sp-logo a { text-decoration: none; color: white; font-size: 20px; font-weight: 700; }
    .sp-card { background: rgba(30, 41, 59, 0.9); border: 1px solid rgba(148, 163, 184, 0.15); border-radius: 16px; padding: 30px; backdrop-filter: blur(10px); }
    .sp-input { width: 100%; padding: 12px 14px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 8px; color: #f1f5f9; font-size: 1rem; box-sizing: border-box; margin-bottom: 12px; }
    .sp-input:focus { outline: none; border-color: #7c3aed; box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2); }
    .sp-input.code-input { text-align: center; font-size: 1.5rem; letter-spacing: 5px; text-transform: uppercase; font-weight: 700; font-family: monospace; }
    .sp-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #7c3aed, #a855f7); border: none; border-radius: 8px; color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .sp-btn:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(124, 58, 237, 0.3); }
    .sp-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .sp-error { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 12px; color: #f87171; font-size: 14px; margin-bottom: 15px; text-align: center; }
    .sp-label { color: #94a3b8; font-size: 14px; margin-bottom: 6px; display: block; }
    .sp-spinner { width: 50px; height: 50px; border: 4px solid #2a3f5f; border-top: 4px solid #7c3aed; border-radius: 50%; margin: 20px auto; animation: sp-spin 1s linear infinite; }
    @@keyframes sp-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<div class="sp-page">
    <div class="sp-logo">
        <a href="/home">üéÆ InternSpark</a>
    </div>

    @if (_state == GameState.EnterCode)
    {
        <div class="sp-center">
            <div class="sp-card">
                <h2 style="color: white; text-align: center; margin: 0 0 5px 0;">Play KBC Solo</h2>
                <p style="color: #94a3b8; text-align: center; margin: 0 0 25px 0;">Enter your admin code to start</p>
                
                @if (!string.IsNullOrEmpty(_error))
                {
                    <div class="sp-error">@_error</div>
                }
                
                <label class="sp-label">Admin Code</label>
                <input @bind="_adminCode" @bind:event="oninput" class="sp-input code-input" placeholder="XXXXXX" maxlength="6" />
                
                <label class="sp-label">Your Name</label>
                <input @bind="_playerName" class="sp-input" placeholder="Enter your name" />
                
                <label class="sp-label">Email (optional)</label>
                <input @bind="_playerEmail" type="email" class="sp-input" placeholder="your@email.com" />
                
                <button @onclick="ValidateCode" class="sp-btn" disabled="@(string.IsNullOrWhiteSpace(_adminCode) || string.IsNullOrWhiteSpace(_playerName))">
                    Continue ‚Üí
                </button>
                
                <div style="text-align: center; margin-top: 15px;">
                    <a href="/home" style="color: #94a3b8; font-size: 13px; text-decoration: none;">‚Üê Back to Home</a>
                    <span style="color: #4b5563; margin: 0 10px;">|</span>
                    <a href="/register" style="color: #818cf8; font-size: 13px; text-decoration: none;">Create Account for full tracking ‚Üí</a>
                </div>
            </div>
        </div>
    }
    else if (_state == GameState.Ready)
    {
        <div class="sp-center">
            <div class="sp-card" style="text-align: center;">
                <div style="font-size: 80px; margin-bottom: 20px;">üéÆ</div>
                <h1 style="color: white; font-size: 28px; margin: 0 0 10px 0;">Kaun Banega Crorepati</h1>
                <p style="color: #9ca3af; margin: 0 0 5px 0;">Welcome, <strong style="color: white;">@_playerName</strong>!</p>
                <p style="color: #6b7280; margin: 0 0 25px 0;">Playing from <strong style="color: #a855f7;">@_adminName</strong>'s question bank</p>
                
                <div style="background: #1a1a2e; border-radius: 12px; padding: 20px; margin-bottom: 25px; text-align: left;">
                    <h3 style="color: white; margin: 0 0 12px 0; font-size: 15px;">Question Availability</h3>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        @for (int i = 1; i <= 15; i++)
                        {
                            var level = i;
                            var count = _levelCounts.GetValueOrDefault(level, 0);
                            <span style="padding: 4px 9px; border-radius: 5px; font-size: 11px; background: @(count > 0 ? "#10b981" : "#ef4444"); color: white;">
                                L@level: @count
                            </span>
                        }
                    </div>
                    @if (_missingLevels.Any())
                    {
                        <p style="color: #ef4444; font-size: 12px; margin: 12px 0 0 0;">‚ö†Ô∏è Missing levels: @string.Join(", ", _missingLevels). Cannot start game.</p>
                    }
                </div>
                
                <button @onclick="StartGame" class="sp-btn" disabled="@(_missingLevels.Any())">
                    ‚ñ∂Ô∏è Start Game ‚Äî Answer 15 questions to win ‚Çπ7 Crore!
                </button>
                
                <div style="margin-top: 15px;">
                    <button @onclick="BackToCode" style="background: transparent; border: none; color: #94a3b8; font-size: 13px; cursor: pointer;">‚Üê Change Code</button>
                </div>
            </div>
        </div>
    }
    else if (_state == GameState.Loading)
    {
        <div class="sp-center" style="text-align: center; padding-top: 80px;">
            <div style="font-size: 60px; margin-bottom: 20px;">üéØ</div>
            <h2 style="color: white;">Loading Question...</h2>
            <p style="color: #9ca3af;">Level @(_gameSession?.CurrentLevel ?? 1)</p>
            <div class="sp-spinner"></div>
        </div>
    }
    else if (_state == GameState.Playing && _currentQuestion != null && _gameSession != null)
    {
        <div class="sp-wide">
            <!-- Top Bar -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="background: #7c3aed; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 14px;">
                        Level @_gameSession.CurrentLevel / 15
                    </span>
                    <span style="color: #9ca3af; font-size: 14px;">@_playerName</span>
                </div>
                
                <!-- Timer -->
                <div style="width: 56px; height: 56px; border-radius: 50%; border: 3px solid @(_timeRemaining <= 10 ? "#ef4444" : "#7c3aed"); display: flex; align-items: center; justify-content: center;">
                    <span style="color: @(_timeRemaining <= 10 ? "#ef4444" : "white"); font-size: 22px; font-weight: 700;">@_timeRemaining</span>
                </div>
                
                <div style="text-align: right;">
                    <p style="color: #9ca3af; margin: 0; font-size: 12px;">Prize</p>
                    <p style="color: #fbbf24; margin: 0; font-size: 22px; font-weight: 700;">@KBCPrizeStructure.FormatPrize(_currentQuestion.GetPrizeAmount())</p>
                </div>
            </div>
            
            <!-- Game Grid -->
            <div style="display: grid; grid-template-columns: 1fr 190px; gap: 20px;">
                <div>
                    <!-- Question -->
                    <div style="background: linear-gradient(180deg, #0f172a, #1e293b); border: 2px solid #7c3aed; border-radius: 16px; padding: 28px; margin-bottom: 20px;">
                        <h2 style="color: white; font-size: 19px; text-align: center; margin: 0; line-height: 1.6;">@_currentQuestion.QuestionText</h2>
                    </div>
                    
                    <!-- Options -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        @foreach (var opt in GetOptions())
                        {
                            var isHidden = _hiddenOptions.Contains(opt.Ans);
                            var isSelected = _selectedAnswer == opt.Ans;
                            var isCorrect = _showAnswer && opt.Ans == _currentQuestion.CorrectAnswer;
                            var isWrong = _showAnswer && isSelected && !isCorrect;
                            
                            <button @onclick="() => SelectAnswer(opt.Ans)" disabled="@(_showAnswer || isHidden)"
                                    style="padding: 16px 18px; border-radius: 12px; text-align: left; cursor: @(_showAnswer || isHidden ? "default" : "pointer"); opacity: @(isHidden ? "0.3" : "1");
                                           background: @(isCorrect ? "rgba(16, 185, 129, 0.3)" : isWrong ? "rgba(239, 68, 68, 0.3)" : isSelected ? "rgba(124, 58, 237, 0.3)" : "rgba(26, 26, 46, 0.9)");
                                           border: 2px solid @(isCorrect ? "#10b981" : isWrong ? "#ef4444" : isSelected ? "#7c3aed" : "#2a3f5f");
                                           color: white; font-size: 15px; transition: all 0.2s;">
                                <strong style="color: @(isCorrect ? "#10b981" : isWrong ? "#ef4444" : "#7c3aed"); margin-right: 8px;">@opt.Label.</strong>
                                @opt.Text
                                @if (isCorrect) { <span style="float: right; color: #10b981;">‚úì</span> }
                                @if (isWrong) { <span style="float: right; color: #ef4444;">‚úó</span> }
                            </button>
                        }
                    </div>
                    
                    <!-- Lifelines -->
                    <div style="background: rgba(22, 33, 62, 0.9); border: 1px solid #2a3f5f; border-radius: 12px; padding: 14px; margin-bottom: 18px;">
                        <p style="color: #9ca3af; font-size: 11px; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 1px;">Lifelines</p>
                        <div style="display: flex; gap: 8px;">
                            <button @onclick="UseFiftyFifty" disabled="@(_localFiftyFiftyUsed || _showAnswer)"
                                    style="flex: 1; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 13px; border: 1px solid @(_localFiftyFiftyUsed ? "#4b5563" : "#f59e0b"); background: @(_localFiftyFiftyUsed ? "#1a1a2e" : "rgba(245, 158, 11, 0.1)"); color: @(_localFiftyFiftyUsed ? "#4b5563" : "#f59e0b"); opacity: @(_localFiftyFiftyUsed ? "0.5" : "1");">
                                50:50
                            </button>
                            <button @onclick="UsePhoneAFriend" disabled="@(_localPhoneAFriendUsed || _showAnswer)"
                                    style="flex: 1; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 13px; border: 1px solid @(_localPhoneAFriendUsed ? "#4b5563" : "#3b82f6"); background: @(_localPhoneAFriendUsed ? "#1a1a2e" : "rgba(59, 130, 246, 0.1)"); color: @(_localPhoneAFriendUsed ? "#4b5563" : "#3b82f6"); opacity: @(_localPhoneAFriendUsed ? "0.5" : "1");">
                                üìû Phone
                            </button>
                            <button @onclick="UseAudiencePoll" disabled="@(_localAudiencePollUsed || _showAnswer)"
                                    style="flex: 1; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 13px; border: 1px solid @(_localAudiencePollUsed ? "#4b5563" : "#10b981"); background: @(_localAudiencePollUsed ? "#1a1a2e" : "rgba(16, 185, 129, 0.1)"); color: @(_localAudiencePollUsed ? "#4b5563" : "#10b981"); opacity: @(_localAudiencePollUsed ? "0.5" : "1");">
                                üë• Audience
                            </button>
                            <button @onclick="UseExpertAdvice" disabled="@(_localExpertAdviceUsed || _showAnswer)"
                                    style="flex: 1; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 13px; border: 1px solid @(_localExpertAdviceUsed ? "#4b5563" : "#8b5cf6"); background: @(_localExpertAdviceUsed ? "#1a1a2e" : "rgba(139, 92, 246, 0.1)"); color: @(_localExpertAdviceUsed ? "#4b5563" : "#8b5cf6"); opacity: @(_localExpertAdviceUsed ? "0.5" : "1");">
                                üéì Expert
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lifeline Result -->
                    @if (!string.IsNullOrEmpty(_lifelineResult))
                    {
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; border-radius: 10px; padding: 14px; margin-bottom: 18px;">
                            <p style="color: #3b82f6; margin: 0; font-size: 14px;">@_lifelineResult</p>
                        </div>
                    }
                    @if (_audiencePoll != null)
                    {
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 10px; padding: 14px; margin-bottom: 18px;">
                            <p style="color: #10b981; margin: 0 0 8px 0; font-weight: 600; font-size: 14px;">Audience Poll:</p>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                @foreach (var (lbl, pct) in new[] { ("A", _audiencePoll.PercentageA), ("B", _audiencePoll.PercentageB), ("C", _audiencePoll.PercentageC), ("D", _audiencePoll.PercentageD) })
                                {
                                    <div style="text-align: center;">
                                        <div style="height: @(pct)px; max-height: 50px; background: #10b981; border-radius: 3px; margin-bottom: 4px;"></div>
                                        <span style="color: white; font-size: 12px;">@lbl: @pct%</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        @if (_selectedAnswer.HasValue && !_showAnswer)
                        {
                            <button @onclick="LockAnswer" style="background: #f59e0b; color: white; border: none; padding: 14px 36px; border-radius: 10px; font-size: 17px; font-weight: 600; cursor: pointer;">
                                üîí Lock Answer
                            </button>
                        }
                        @if (_showAnswer)
                        {
                            @if (_isCorrect)
                            {
                                <button @onclick="NextQuestion" style="background: #10b981; color: white; border: none; padding: 14px 36px; border-radius: 10px; font-size: 17px; font-weight: 600; cursor: pointer;">
                                    @(_gameSession.CurrentLevel >= 15 ? "üèÜ Claim Prize" : "Next Question ‚Üí")
                                </button>
                            }
                            else
                            {
                                <button @onclick="() => { _state = GameState.GameOver; }" style="background: #ef4444; color: white; border: none; padding: 14px 36px; border-radius: 10px; font-size: 17px; font-weight: 600; cursor: pointer;">
                                    End Game
                                </button>
                            }
                        }
                        @if (!_showAnswer)
                        {
                            <button @onclick="QuitGame" style="background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 14px 24px; border-radius: 10px; font-size: 15px; cursor: pointer;">
                                Quit & Take @KBCPrizeStructure.FormatPrize(_gameSession.CurrentPrize)
                            </button>
                        }
                    </div>
                </div>
                
                <!-- Prize Ladder -->
                <div style="background: rgba(22, 33, 62, 0.9); border: 1px solid #2a3f5f; border-radius: 12px; padding: 14px;">
                    <p style="color: #9ca3af; font-size: 10px; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 1px;">Prize Ladder</p>
                    @for (int i = 15; i >= 1; i--)
                    {
                        var level = i;
                        var isCurrent = level == _gameSession.CurrentLevel;
                        var isPassed = level < _gameSession.CurrentLevel;
                        var isMilestone = level == 5 || level == 10;
                        
                        <div style="display: flex; justify-content: space-between; padding: 5px 7px; margin-bottom: 1px; border-radius: 3px; background: @(isCurrent ? "#7c3aed" : isPassed ? "rgba(16, 185, 129, 0.2)" : "transparent"); border: @(isMilestone ? "1px solid #fbbf24" : "none");">
                            <span style="color: @(isCurrent ? "white" : isPassed ? "#10b981" : "#6b7280"); font-size: 11px;">@level</span>
                            <span style="color: @(isCurrent ? "white" : isPassed ? "#10b981" : isMilestone ? "#fbbf24" : "#9ca3af"); font-size: 11px; font-weight: @(isMilestone ? "600" : "400");">
                                @KBCPrizeStructure.FormatPrize(KBCPrizeStructure.LevelPrizes[level])
                            </span>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
    else if (_state == GameState.GameOver && _gameSession != null)
    {
        <div class="sp-center" style="text-align: center; padding-top: 30px;">
            <div style="font-size: 100px; margin-bottom: 20px;">@(_gameSession.Status == GameStatus.Won ? "üèÜ" : "üòî")</div>
            <h1 style="color: white; font-size: 34px; margin: 0 0 10px 0;">
                @(_gameSession.Status == GameStatus.Won ? "Congratulations!" : "Game Over")
            </h1>
            <p style="color: #9ca3af; font-size: 18px; margin: 0 0 25px 0;">@_playerName</p>
            
            <div style="background: linear-gradient(135deg, rgba(26, 26, 46, 0.9), rgba(22, 33, 62, 0.9)); border: 2px solid #fbbf24; border-radius: 16px; padding: 28px; margin-bottom: 25px;">
                <p style="color: #9ca3af; margin: 0 0 8px 0;">You Won</p>
                <h2 style="color: #fbbf24; font-size: 44px; margin: 0;">@KBCPrizeStructure.FormatPrize(_gameSession.FinalPrize)</h2>
                <p style="color: #6b7280; margin: 12px 0 0 0; font-size: 14px;">
                    Reached Level @_gameSession.CurrentLevel | @_gameSession.CorrectAnswers/@_gameSession.QuestionsAnswered Correct | Time: @_gameSession.GetDuration()
                </p>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button @onclick="PlayAgain" style="background: #7c3aed; color: white; border: none; padding: 12px 28px; border-radius: 8px; font-size: 16px; cursor: pointer;">
                    üîÑ Play Again
                </button>
                <a href="/home" style="background: transparent; border: 1px solid #2a3f5f; color: white; padding: 12px 28px; border-radius: 8px; text-decoration: none; font-size: 16px;">
                    üè† Home
                </a>
            </div>
            
            <div style="margin-top: 20px;">
                <a href="/register" style="color: #818cf8; text-decoration: none; font-size: 13px;">Create an account to track all your games ‚Üí</a>
            </div>
        </div>
    }
</div>

@code {
    enum GameState { EnterCode, Ready, Loading, Playing, GameOver }
    
    private GameState _state = GameState.EnterCode;
    private string _error = "";
    private string _adminCode = "";
    private string _playerName = "";
    private string _playerEmail = "";
    private string _adminName = "";
    private Guid _adminId;
    private Dictionary<int, int> _levelCounts = new();
    private List<int> _missingLevels = new();
    
    // Game state
    private GameSession? _gameSession;
    private Question? _currentQuestion;
    private List<Guid> _usedQuestionIds = new();
    private CorrectOption? _selectedAnswer;
    private bool _showAnswer = false;
    private bool _isCorrect = false;
    private bool _isDisposed = false;
    
    // Timer
    private int _timeRemaining = 30;
    private System.Threading.Timer? _timer;
    private int _timeTaken = 0;
    
    // Lifelines
    private List<CorrectOption> _hiddenOptions = new();
    private string _lifelineResult = "";
    private AudiencePollResult? _audiencePoll;
    private LifelineUsage _currentLifelineUsage = new();
    private bool _localFiftyFiftyUsed = false;
    private bool _localPhoneAFriendUsed = false;
    private bool _localAudiencePollUsed = false;
    private bool _localExpertAdviceUsed = false;

    private async Task ValidateCode()
    {
        _error = "";
        if (string.IsNullOrWhiteSpace(_adminCode) || _adminCode.Trim().Length < 4) { _error = "Please enter a valid admin code"; return; }
        if (string.IsNullOrWhiteSpace(_playerName)) { _error = "Please enter your name"; return; }
        
        var admin = await UserService.ValidateAdminCodeAsync(_adminCode.Trim());
        if (admin == null) { _error = "Invalid admin code. Please check and try again."; return; }
        
        _adminId = admin.Id;
        _adminName = admin.FullName;
        
        await UserService.RegisterOrGetPublicUserAsync(_playerName.Trim(), _playerEmail.Trim(), _adminId);
        
        _levelCounts = await QuestionService.GetQuestionCountByLevelAsync(_adminId);
        _missingLevels = Enumerable.Range(1, 15).Where(l => _levelCounts.GetValueOrDefault(l, 0) == 0).ToList();
        
        _state = GameState.Ready;
    }

    private async Task StartGame()
    {
        if (_missingLevels.Any()) return;
        
        _gameSession = await GameService.StartNewGameAsync(_playerName, _adminId);
        _usedQuestionIds.Clear();
        _localFiftyFiftyUsed = false; _localPhoneAFriendUsed = false;
        _localAudiencePollUsed = false; _localExpertAdviceUsed = false;
        
        await LoadQuestion();
    }

    private async Task LoadQuestion()
    {
        if (_gameSession == null) return;
        _timer?.Dispose(); _timer = null;
        _state = GameState.Loading;
        _currentQuestion = null;
        StateHasChanged();
        
        try
        {
            await Task.Delay(100);
            _currentQuestion = await GameService.GetQuestionForLevelAsync(_gameSession.CurrentLevel, _adminId, _usedQuestionIds);
            
            if (_currentQuestion == null) { _error = $"No question for level {_gameSession.CurrentLevel}"; _state = GameState.GameOver; return; }
            
            _usedQuestionIds.Add(_currentQuestion.Id);
            _selectedAnswer = null; _showAnswer = false; _isCorrect = false;
            _hiddenOptions.Clear(); _lifelineResult = ""; _audiencePoll = null;
            _currentLifelineUsage = new();
            
            _state = GameState.Playing;
            await PlaySound("soundQuestion");
            
            _timeRemaining = _currentQuestion.GetTimeLimitForLevel();
            _timeTaken = 0;
            StartTimer();
        }
        catch (Exception ex) { _error = ex.Message; _state = GameState.GameOver; }
    }

    private void StartTimer()
    {
        _timer?.Dispose();
        _timer = new System.Threading.Timer(async _ =>
        {
            try
            {
                if (_timer == null || _isDisposed) return;
                _timeRemaining--; _timeTaken++;
                if (_timeRemaining <= 0)
                {
                    _timer?.Dispose(); _timer = null;
                    if (!_isDisposed) await InvokeAsync(async () => { await TimeOut(); StateHasChanged(); });
                }
                else if (!_isDisposed) await InvokeAsync(StateHasChanged);
            }
            catch { }
        }, null, 1000, 1000);
    }

    private async Task TimeOut()
    {
        _timer?.Dispose(); _timer = null;
        _showAnswer = true; _isCorrect = false;
        try
        {
            _gameSession = await GameService.RecordAnswerAsync(_gameSession!.Id, _currentQuestion!.Id, null, _timeTaken, true, _currentLifelineUsage);
            _state = GameState.GameOver;
        }
        catch { _state = GameState.GameOver; }
    }

    private void SelectAnswer(CorrectOption answer)
    {
        if (!_showAnswer && !_hiddenOptions.Contains(answer)) _selectedAnswer = answer;
    }

    private async Task LockAnswer()
    {
        if (!_selectedAnswer.HasValue || _currentQuestion == null || _gameSession == null) return;
        _timer?.Dispose(); _timer = null;
        _showAnswer = true;
        _isCorrect = _selectedAnswer == _currentQuestion.CorrectAnswer;
        await PlaySound(_isCorrect ? "soundCorrect" : "soundWrong");
        
        try
        {
            _gameSession = await GameService.RecordAnswerAsync(_gameSession.Id, _currentQuestion.Id, _selectedAnswer, _timeTaken, false, _currentLifelineUsage);
            if (!_isCorrect || _gameSession.Status != GameStatus.InProgress)
            {
                if (_gameSession.Status == GameStatus.Won) { await PlaySound("soundWin"); }
                _state = GameState.GameOver;
            }
            else await PlaySound("soundLevelUp");
        }
        catch { }
    }

    private async Task NextQuestion()
    {
        _timer?.Dispose(); _timer = null;
        if (_gameSession?.Status == GameStatus.Won) _state = GameState.GameOver;
        else
        {
            try { await LoadQuestion(); }
            catch { _state = GameState.GameOver; }
        }
    }

    private async Task QuitGame()
    {
        _timer?.Dispose(); _timer = null;
        _gameSession = await GameService.QuitGameAsync(_gameSession!.Id);
        _state = GameState.GameOver;
    }

    private void PlayAgain()
    {
        _timer?.Dispose(); _timer = null;
        _gameSession = null; _currentQuestion = null; _usedQuestionIds.Clear();
        _localFiftyFiftyUsed = false; _localPhoneAFriendUsed = false;
        _localAudiencePollUsed = false; _localExpertAdviceUsed = false;
        _error = "";
        _state = GameState.Ready;
    }

    private void BackToCode() { _state = GameState.EnterCode; _error = ""; }

    // Lifelines
    private async Task UseFiftyFifty()
    {
        if (_currentQuestion == null || _localFiftyFiftyUsed || _showAnswer) return;
        try { _localFiftyFiftyUsed = true; var (removed, _) = await GameService.GetFiftyFiftyOptionsAsync(_currentQuestion); _hiddenOptions = removed; _currentLifelineUsage.FiftyFifty = true; StateHasChanged(); }
        catch { _localFiftyFiftyUsed = false; }
    }

    private async Task UsePhoneAFriend()
    {
        if (_currentQuestion == null || _localPhoneAFriendUsed || _showAnswer) return;
        try { _localPhoneAFriendUsed = true; _lifelineResult = await GameService.GetPhoneAFriendHintAsync(_currentQuestion); _currentLifelineUsage.PhoneAFriend = true; StateHasChanged(); }
        catch { _localPhoneAFriendUsed = false; }
    }

    private async Task UseAudiencePoll()
    {
        if (_currentQuestion == null || _localAudiencePollUsed || _showAnswer) return;
        try { _localAudiencePollUsed = true; _audiencePoll = await GameService.GetAudiencePollAsync(_currentQuestion); _currentLifelineUsage.AudiencePoll = true; StateHasChanged(); }
        catch { _localAudiencePollUsed = false; }
    }

    private async Task UseExpertAdvice()
    {
        if (_currentQuestion == null || _localExpertAdviceUsed || _showAnswer) return;
        try { _localExpertAdviceUsed = true; var (answer, confidence) = await GameService.GetExpertAdviceAsync(_currentQuestion); _lifelineResult = $"üéì Expert says: \"I'm {confidence}% confident the answer is Option {answer}\""; _currentLifelineUsage.ExpertAdvice = true; StateHasChanged(); }
        catch { _localExpertAdviceUsed = false; }
    }

    private (string Label, string Text, CorrectOption Ans)[] GetOptions() => _currentQuestion == null
        ? Array.Empty<(string, string, CorrectOption)>()
        : new[] { ("A", _currentQuestion.OptionA, CorrectOption.A), ("B", _currentQuestion.OptionB, CorrectOption.B), ("C", _currentQuestion.OptionC, CorrectOption.C), ("D", _currentQuestion.OptionD, CorrectOption.D) };

    private async Task PlaySound(string id)
    {
        try { await JSRuntime.InvokeVoidAsync("eval", $"document.getElementById('{id}')?.play()"); } catch { }
    }

    public void Dispose() { _isDisposed = true; _timer?.Dispose(); _timer = null; }
}
